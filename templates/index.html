<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veterans Verify - 控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-900 min-h-screen">
{% raw %}
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Veterans Verify</h1>
            <div class="flex items-center gap-4">
                <span class="text-green-400 text-sm">运行中</span>
                <button @click="restartService" class="text-yellow-400 hover:text-yellow-300 text-sm">重启服务</button>
                <a href="/logout" class="text-gray-400 hover:text-white text-sm">退出</a>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="text-gray-400 text-sm">军人数据</div>
                <div class="text-2xl font-bold text-white">{{ vetStats.available || 0 }}</div>
                <div class="text-xs text-gray-500">可用</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="text-gray-400 text-sm">邮箱池</div>
                <div class="text-2xl font-bold text-blue-400">{{ emailPoolStats.available || 0 }}</div>
                <div class="text-xs text-gray-500">可用</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="text-gray-400 text-sm">账号</div>
                <div class="text-2xl font-bold text-white">{{ accountStats.total || 0 }}</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="text-gray-400 text-sm">验证成功</div>
                <div class="text-2xl font-bold text-green-400">{{ accountStats.verified || 0 }}</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="text-gray-400 text-sm">验证失败</div>
                <div class="text-2xl font-bold text-red-400">{{ accountStats.failed || 0 }}</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="text-gray-400 text-sm">待验证</div>
                <div class="text-2xl font-bold text-yellow-400">{{ accountStats.pending || 0 }}</div>
            </div>
        </div>

        <!-- 运行中任务面板 -->
        <div v-if="runningTask" class="bg-yellow-900/50 border border-yellow-600 rounded-lg p-4 mb-8">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                    <span class="text-yellow-400 font-semibold">任务运行中</span>
                    <span class="text-white text-sm">{{ runningTask.email }}</span>
                    <span class="text-gray-400 text-xs">({{ runningTask.mode }})</span>
                </div>
                <div class="flex gap-2">
                    <button @click="showEmergencyLogin(runningTask.email)"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-1 rounded text-sm">
                        🆘 应急登录
                    </button>
                    <button @click="logoutChatgpt"
                        class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-1 rounded text-sm">
                        退出登录
                    </button>
                    <button @click="restartTask(runningTask.email)"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded text-sm">
                        重启
                    </button>
                    <button @click="stopTask(runningTask.email)"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-1 rounded text-sm">
                        停止
                    </button>
                </div>
            </div>
            <div class="bg-gray-900 rounded p-3 h-40 overflow-y-auto font-mono text-xs" ref="logContainer">
                <div v-for="(log, idx) in runningTask.logs" :key="idx" class="text-gray-300">{{ log }}</div>
                <div v-if="!runningTask.logs || runningTask.logs.length === 0" class="text-gray-500">等待日志...</div>
            </div>
        </div>

        <!-- 应急登录模态框 -->
        <div v-if="emergencyModal.show" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @click.self="emergencyModal.show = false">
            <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-orange-400">🆘 应急手动登录</h3>
                    <button @click="emergencyModal.show = false" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div v-if="emergencyModal.loading" class="text-center py-8 text-gray-400">加载中...</div>
                <div v-else>
                    <!-- 说明 -->
                    <div class="bg-orange-900/30 border border-orange-600 rounded p-3 mb-4">
                        <div class="text-orange-300 text-sm">
                            脚本卡住时，可手动登录后继续验证：
                        </div>
                    </div>

                    <!-- ChatGPT 登录信息 -->
                    <div class="bg-gray-700 rounded p-4 mb-4">
                        <h4 class="text-white font-semibold mb-3">1. ChatGPT 登录信息</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="text-gray-400 w-16">邮箱:</div>
                                <div class="text-white font-mono flex-1 bg-gray-800 px-2 py-1 rounded select-all">{{ emergencyModal.email }}</div>
                                <button @click="copyText(emergencyModal.email)" class="text-blue-400 hover:text-blue-300 text-xs">复制</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="text-gray-400 w-16">密码:</div>
                                <div class="text-green-400 font-mono flex-1 bg-gray-800 px-2 py-1 rounded select-all">{{ emergencyModal.password }}</div>
                                <button @click="copyText(emergencyModal.password)" class="text-blue-400 hover:text-blue-300 text-xs">复制</button>
                            </div>
                        </div>
                    </div>

                    <!-- 注册信息（姓名+生日）-->
                    <div v-if="emergencyModal.profileData" class="bg-blue-900/30 border border-blue-600/50 rounded p-4 mb-4">
                        <h4 class="text-blue-400 font-semibold mb-3">2. 注册信息（如果要求填写）</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="text-gray-400 w-12">姓名:</div>
                                <div class="text-white font-mono bg-gray-800 px-2 py-1 rounded select-all">{{ emergencyModal.profileData.first_name }} {{ emergencyModal.profileData.last_name }}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="text-gray-400 w-12">生日:</div>
                                <div class="text-white font-mono bg-gray-800 px-2 py-1 rounded select-all">{{ emergencyModal.profileData.birth_month }} {{ emergencyModal.profileData.birth_day }}, {{ emergencyModal.profileData.birth_year }}</div>
                            </div>
                        </div>
                        <div class="text-gray-400 text-xs mt-2">⚠️ 注册 ChatGPT 时要求填写姓名/生日时使用（保持一致）</div>
                    </div>

                    <!-- 登录步骤 -->
                    <div class="bg-gray-700 rounded p-4 mb-4">
                        <h4 class="text-white font-semibold mb-2">3. 登录步骤</h4>
                        <div class="text-gray-300 text-sm space-y-1">
                            <div>① 打开 <a href="https://chatgpt.com/veterans-claim" target="_blank" class="text-blue-400 underline">veterans-claim</a></div>
                            <div>② 点击 "登录" 按钮</div>
                            <div>③ 输入邮箱和密码（注册时用上面的姓名/生日）</div>
                            <div>④ 如需验证码，访问 <a href="https://one.009025.xyz/" target="_blank" class="text-blue-400 underline">临时邮箱</a> 获取</div>
                            <div>⑤ 登录成功后点击下方按钮继续</div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex gap-3">
                        <button @click="manualContinueVerify()"
                            :disabled="emergencyModal.continuing"
                            class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white py-3 rounded font-semibold">
                            {{ emergencyModal.continuing ? '继续中...' : '✓ 我已登录，继续验证' }}
                        </button>
                        <button @click="emergencyModal.show = false"
                            class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-3 rounded">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模式选择 Tabs -->
        <div class="bg-gray-800 rounded-lg mb-8">
            <div class="flex border-b border-gray-700">
                <button v-for="mode in modes" :key="mode.id"
                    @click="currentMode = mode.id"
                    :class="currentMode === mode.id ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-white'"
                    class="px-6 py-3 border-b-2 font-medium text-sm transition">
                    {{ mode.name }}
                </button>
            </div>

            <div class="p-6">
                <!-- 模式1: 邮箱池管理 -->
                <div v-if="currentMode === 'email_pool'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-white font-semibold mb-4">批量创建邮箱</h3>
                            <div class="flex gap-2 mb-4">
                                <input v-model.number="emailCreateCount" type="number" min="1" max="50"
                                    class="w-24 bg-gray-700 text-white px-3 py-2 rounded" placeholder="数量">
                                <button @click="createEmails" :disabled="creatingEmails"
                                    class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white px-4 py-2 rounded">
                                    {{ creatingEmails ? '创建中...' : '创建邮箱' }}
                                </button>
                            </div>
                            <h3 class="text-white font-semibold mb-2">添加外部邮箱</h3>
                            <div class="space-y-2">
                                <input v-model="externalEmail" type="email" placeholder="邮箱地址"
                                    class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                <input v-model="externalJwt" type="text" placeholder="JWT Token"
                                    class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                <button @click="addExternalEmail"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                    添加
                                </button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-white font-semibold">邮箱列表 <span class="text-gray-400 text-sm">({{ visibleEmails.length }})</span></h3>
                                <button @click="reloadEmailPool" class="text-blue-400 hover:text-blue-300 text-sm">刷新</button>
                            </div>
                            <div class="max-h-64 overflow-y-auto space-y-2">
                                <div v-for="email in visibleEmails" :key="email.address"
                                    class="bg-gray-700 rounded p-3 flex justify-between items-center">
                                    <div class="flex-1 min-w-0">
                                        <div class="text-white text-sm font-mono truncate">{{ email.address }}</div>
                                        <!-- ChatGPT 登录密码 -->
                                        <div v-if="email.password" class="text-xs text-green-400 font-mono mt-0.5">
                                            <span class="text-gray-400">密码:</span> {{ email.password }}
                                            <button @click="copyText(email.password)" class="text-blue-400 hover:text-blue-300 ml-1">复制</button>
                                        </div>
                                        <!-- 注册信息：姓名+生日（可复制） -->
                                        <div v-if="email.first_name" class="text-xs text-yellow-400 font-mono mt-0.5">
                                            <span class="text-gray-400">姓名:</span> {{ email.first_name }} {{ email.last_name }}
                                            <button @click="copyText(email.first_name + ' ' + email.last_name)" class="text-blue-400 hover:text-blue-300 ml-1">复制</button>
                                            <span class="text-gray-400 ml-2">生日:</span> {{ email.birth_month }} {{ email.birth_day }}, {{ email.birth_year }}
                                            <button @click="copyText(email.birth_month + ' ' + email.birth_day + ', ' + email.birth_year)" class="text-blue-400 hover:text-blue-300 ml-1">复制</button>
                                        </div>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs px-2 py-0.5 rounded"
                                                :class="{
                                                    'bg-green-600 text-green-100': email.status === 'available',
                                                    'bg-blue-600 text-blue-100': email.status === 'in_use',
                                                    'bg-green-700 text-green-100': email.status === 'verified',
                                                    'bg-orange-600 text-orange-100': email.status === 'consumed',
                                                    'bg-red-600 text-red-100': email.status === 'failed'
                                                }">
                                                {{ email.status }}
                                            </span>
                                            <!-- consumed 显示被谁消耗 -->
                                            <span v-if="email.consumed_by" class="text-xs text-orange-400" :title="'被 ' + email.consumed_by + ' 消耗'">
                                                → {{ email.consumed_by.substring(0, 18) }}...
                                            </span>
                                            <!-- verified 账号显示消耗的邮箱 -->
                                            <span v-else-if="email.consumed_email" class="text-xs text-purple-400" :title="'消耗了 ' + email.consumed_email">
                                                ← {{ email.consumed_email.substring(0, 18) }}...
                                            </span>
                                            <span v-else-if="email.linked_account" class="text-xs text-yellow-400" :title="'关联账号: ' + email.linked_account">
                                                → {{ email.linked_account.substring(0, 15) }}...
                                            </span>
                                        </div>
                                        <!-- 错误信息 -->
                                        <div v-if="email.error_message" class="text-xs text-red-400 mt-1 truncate" :title="email.error_message">
                                            {{ email.error_message }}
                                        </div>
                                        <!-- 成功军人信息 -->
                                        <div v-if="email.verified_veteran" class="text-xs text-green-400 mt-1">
                                            ✓ {{ email.verified_veteran.first_name }} {{ email.verified_veteran.last_name }} ({{ email.verified_veteran.branch }})
                                        </div>
                                    </div>
                                    <button @click="deleteEmail(email.address)" class="text-red-400 hover:text-red-300 text-sm ml-2">删除</button>
                                </div>
                                <div v-if="visibleEmails.length === 0" class="text-gray-500 text-center py-4">暂无邮箱</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 模式2: 代理管理 -->
                <div v-if="currentMode === 'proxy_manage'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 左侧：添加代理 -->
                        <div>
                            <h3 class="text-white font-semibold mb-4">添加代理</h3>

                            <!-- Tab 切换：粘贴 vs 上传 -->
                            <div class="flex gap-2 mb-4">
                                <button @click="proxyInputMethod = 'paste'"
                                    :class="proxyInputMethod === 'paste' ? 'bg-blue-600' : 'bg-gray-700'"
                                    class="px-4 py-2 rounded text-white text-sm">
                                    粘贴代理
                                </button>
                                <button @click="proxyInputMethod = 'upload'"
                                    :class="proxyInputMethod === 'upload' ? 'bg-blue-600' : 'bg-gray-700'"
                                    class="px-4 py-2 rounded text-white text-sm">
                                    上传文件
                                </button>
                            </div>

                            <!-- 粘贴模式 -->
                            <div v-if="proxyInputMethod === 'paste'">
                                <label class="block text-gray-400 text-sm mb-2">代理列表（每行一个）</label>
                                <textarea v-model="proxyText" rows="8"
                                    placeholder="支持格式：&#10;ip:port&#10;ip:port:user:pass&#10;user:pass@ip:port&#10;http://ip:port&#10;socks5://user:pass@ip:port"
                                    class="w-full bg-gray-700 text-white rounded p-2 text-sm font-mono"></textarea>

                                <div class="flex items-center gap-2 mt-3">
                                    <label class="text-gray-400 text-sm">协议类型：</label>
                                    <select v-model="proxyProtocol" class="bg-gray-700 text-white rounded px-3 py-1 text-sm">
                                        <option value="http">HTTP</option>
                                        <option value="https">HTTPS</option>
                                        <option value="socks5">SOCKS5</option>
                                    </select>
                                    <button @click="parseProxyText" :disabled="!proxyText || proxyParsing"
                                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white px-4 py-1 rounded text-sm ml-auto">
                                        {{ proxyParsing ? '解析中...' : '解析并预览' }}
                                    </button>
                                </div>
                            </div>

                            <!-- 上传模式 -->
                            <div v-if="proxyInputMethod === 'upload'">
                                <label class="block text-gray-400 text-sm mb-2">选择代理文件（.txt）</label>
                                <input type="file" @change="handleProxyFileChange" accept=".txt"
                                    class="w-full bg-gray-700 text-white rounded p-2 text-sm">

                                <div class="flex items-center gap-2 mt-3">
                                    <label class="text-gray-400 text-sm">协议类型：</label>
                                    <select v-model="proxyProtocol" class="bg-gray-700 text-white rounded px-3 py-1 text-sm">
                                        <option value="http">HTTP</option>
                                        <option value="https">HTTPS</option>
                                        <option value="socks5">SOCKS5</option>
                                    </select>
                                    <button @click="uploadProxyFile" :disabled="!proxyFile || proxyParsing"
                                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white px-4 py-1 rounded text-sm ml-auto">
                                        {{ proxyParsing ? '上传中...' : '上传并解析' }}
                                    </button>
                                </div>
                            </div>

                            <!-- 解析结果 -->
                            <div v-if="proxyParsedList.length > 0" class="mt-4">
                                <div class="bg-green-900/30 border border-green-600/50 rounded p-3 mb-2">
                                    <div class="text-green-400 text-sm">
                                        ✅ 成功解析 {{ proxyParsedList.length }} 个代理
                                    </div>
                                </div>
                                <div class="bg-gray-700 rounded p-3 max-h-40 overflow-y-auto">
                                    <div v-for="(proxy, idx) in proxyParsedList.slice(0, 10)" :key="idx"
                                        class="text-gray-300 text-xs font-mono">
                                        {{ proxy }}
                                    </div>
                                    <div v-if="proxyParsedList.length > 10" class="text-gray-500 text-xs mt-2">
                                        ...还有 {{ proxyParsedList.length - 10 }} 个
                                    </div>
                                </div>
                                <button @click="saveProxyList"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded mt-3">
                                    保存到代理池
                                </button>
                            </div>
                        </div>

                        <!-- 右侧：代理池状态 -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-white font-semibold">代理池状态</h3>
                                <button @click="loadProxyStats"
                                    class="text-blue-400 hover:text-blue-300 text-sm">
                                    🔄 刷新
                                </button>
                            </div>

                            <!-- 统计卡片 -->
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="bg-gray-700 rounded p-3">
                                    <div class="text-gray-400 text-xs">总代理数</div>
                                    <div class="text-2xl font-bold text-white">{{ proxyStats.pool?.total || 0 }}</div>
                                </div>
                                <div class="bg-gray-700 rounded p-3">
                                    <div class="text-gray-400 text-xs">可用代理</div>
                                    <div class="text-2xl font-bold text-green-400">{{ proxyStats.pool?.available || 0 }}</div>
                                </div>
                                <div class="bg-gray-700 rounded p-3">
                                    <div class="text-gray-400 text-xs">失败冷却</div>
                                    <div class="text-2xl font-bold text-red-400">{{ proxyStats.pool?.bad || 0 }}</div>
                                </div>
                                <div class="bg-gray-700 rounded p-3">
                                    <div class="text-gray-400 text-xs">分配策略</div>
                                    <div class="text-sm font-bold text-blue-400">{{ proxyStats.pool?.strategy || '-' }}</div>
                                </div>
                            </div>

                            <!-- 主代理 -->
                            <div class="bg-yellow-900/30 border border-yellow-600/50 rounded p-3 mb-4">
                                <div class="text-yellow-400 text-sm font-semibold mb-1">主代理（Fallback）</div>
                                <div class="text-gray-300 text-xs font-mono break-all">
                                    {{ proxyStats.main_proxy || '未配置' }}
                                </div>
                            </div>

                            <!-- 代理模式 -->
                            <div class="bg-gray-700 rounded p-3 mb-4">
                                <div class="text-gray-400 text-xs mb-2">代理模式</div>
                                <div class="text-white text-sm">
                                    <span v-if="proxyStats.mode === 'pool_with_fallback'">
                                        🔄 代理池优先，失败时用主代理（推荐）
                                    </span>
                                    <span v-else-if="proxyStats.mode === 'pool_only'">
                                        📋 只使用代理池
                                    </span>
                                    <span v-else-if="proxyStats.mode === 'main_only'">
                                        🔒 只使用主代理
                                    </span>
                                    <span v-else>-</span>
                                </div>
                            </div>

                            <!-- 代理列表（前10个）-->
                            <div>
                                <div class="text-gray-400 text-sm mb-2">当前可用代理（前10个）</div>
                                <div class="bg-gray-700 rounded p-3 max-h-48 overflow-y-auto">
                                    <div v-for="(proxy, idx) in (proxyStats.pool?.proxies || []).slice(0, 10)" :key="idx"
                                        class="text-gray-300 text-xs font-mono mb-1">
                                        {{ idx + 1 }}. {{ proxy }}
                                    </div>
                                    <div v-if="!proxyStats.pool?.proxies || proxyStats.pool.proxies.length === 0"
                                        class="text-gray-500 text-sm text-center py-4">
                                        暂无可用代理
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 模式3: 全自动（支持批量） -->
                <div v-if="currentMode === 'full_auto'">
                    <div class="bg-green-900/30 border border-green-600/50 rounded-lg p-3 mb-4">
                        <div class="text-green-400 font-semibold">批量验证模式</div>
                        <div class="text-gray-300 text-sm">从邮箱池依次验证，成功指定数量后自动暂停</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-400 text-sm mb-1">成功数量后暂停</label>
                            <input v-model.number="batchSuccessCount" type="number" min="1" max="50"
                                class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="1">
                        </div>
                        <div>
                            <label class="block text-gray-400 text-sm mb-1">邮箱来源</label>
                            <select v-model="autoEmailSource" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                <option value="pool">从邮箱池依次使用</option>
                                <option value="create">自动创建新邮箱</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button @click="startFullAuto" :disabled="fullAutoRunning"
                                class="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white px-6 py-2 rounded w-full">
                                {{ fullAutoRunning ? '运行中...' : '开始批量验证' }}
                            </button>
                        </div>
                    </div>
                    <div v-if="autoEmailSource === 'pool'" class="mt-3 text-gray-400 text-sm">
                        可用邮箱: {{ availableEmails.length }} 个
                    </div>
                </div>

                <!-- 模式3: 单账号验证（合并原来的半自动模式） -->
                <div v-if="currentMode === 'single_verify'">
                    <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 mb-4">
                        <div class="text-blue-400 font-semibold">单账号验证</div>
                        <div class="text-gray-300 text-sm">验证单个 ChatGPT 账号，成功后暂停（可用于已有账号或邮箱池账号）</div>
                    </div>

                    <!-- 验证模式选择 -->
                    <div class="mb-4">
                        <label class="block text-gray-400 text-sm mb-2">验证模式</label>
                        <div class="flex flex-wrap gap-3">
                            <!-- 可视化调试（Camoufox 有窗口，推荐）-->
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleVerifyMode === 'visual' ? 'ring-2 ring-green-500' : ''">
                                <input type="radio" v-model="singleVerifyMode" value="visual" class="mr-2">
                                <div>
                                    <div class="font-semibold text-green-400">🖥️ 可视化调试（推荐）</div>
                                    <div class="text-xs text-gray-400">Camoufox 有窗口，每次新指纹</div>
                                </div>
                            </label>
                            <!-- 全自动后台（Camoufox 无头）-->
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleVerifyMode === 'headless' ? 'ring-2 ring-blue-500' : ''">
                                <input type="radio" v-model="singleVerifyMode" value="headless" class="mr-2">
                                <div>
                                    <div class="font-semibold">🤖 全自动后台</div>
                                    <div class="text-xs text-gray-400">Camoufox 无头，完全后台</div>
                                </div>
                            </label>
                            <!-- 自有账号模式 -->
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleVerifyMode === 'own_account' ? 'ring-2 ring-orange-500' : ''">
                                <input type="radio" v-model="singleVerifyMode" value="own_account" class="mr-2">
                                <div>
                                    <div class="font-semibold text-orange-400">📧 自有账号</div>
                                    <div class="text-xs text-gray-400">Gmail等，需手动输入验证码</div>
                                </div>
                            </label>
                            <!-- CDP 手动登录（推荐调试）-->
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleVerifyMode === 'cdp_manual' ? 'ring-2 ring-blue-500' : ''">
                                <input type="radio" v-model="singleVerifyMode" value="cdp_manual" class="mr-2">
                                <div>
                                    <div class="font-semibold text-blue-400">🔑 CDP 手动登录</div>
                                    <div class="text-xs text-gray-400">你手动登录，脚本自动验证</div>
                                </div>
                            </label>
                            <!-- CDP 全自动（保留）-->
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleVerifyMode === 'cdp' ? 'ring-2 ring-gray-500' : ''">
                                <input type="radio" v-model="singleVerifyMode" value="cdp" class="mr-2">
                                <div>
                                    <div class="font-semibold text-gray-400">🔌 CDP 全自动</div>
                                    <div class="text-xs text-gray-500">脚本自动登录（固定指纹）</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 可视化调试模式提示（推荐） -->
                    <div v-if="singleVerifyMode === 'visual'" class="bg-green-900/30 border border-green-600/50 rounded p-3 mb-4">
                        <div class="text-green-400 font-semibold mb-2 text-sm">可视化调试模式（推荐）</div>
                        <div class="text-gray-300 text-xs space-y-1">
                            <div>1. 从邮箱池选择临时邮箱</div>
                            <div>2. 自动启动 Camoufox 浏览器（有窗口）</div>
                            <div>3. <span class="text-green-400">每次自动生成新指纹</span>（解决固定指纹问题）</div>
                            <div>4. 你可以实时看到浏览器操作过程</div>
                            <div>5. 验证码自动从临时邮箱获取</div>
                        </div>
                    </div>

                    <!-- 全自动后台模式提示 -->
                    <div v-if="singleVerifyMode === 'headless'" class="bg-blue-900/30 border border-blue-600/50 rounded p-3 mb-4">
                        <div class="text-blue-400 font-semibold mb-2 text-sm">全自动后台模式</div>
                        <div class="text-gray-300 text-xs space-y-1">
                            <div>1. 从邮箱池选择临时邮箱</div>
                            <div>2. Camoufox 无头模式（完全后台）</div>
                            <div>3. 每次自动生成新指纹</div>
                            <div>4. 验证码自动从临时邮箱获取</div>
                            <div>5. 适合批量运行，不占用屏幕</div>
                        </div>
                    </div>

                    <!-- CDP 手动登录模式提示（推荐调试）-->
                    <div v-if="singleVerifyMode === 'cdp_manual'" class="bg-blue-900/30 border border-blue-600/50 rounded p-3 mb-4">
                        <div class="text-blue-400 font-semibold mb-2 text-sm">🔑 CDP 手动登录模式（推荐调试）</div>
                        <div class="text-gray-300 text-xs space-y-1">
                            <div>1. 启动 Chrome: <code class="bg-gray-700 px-1">scripts\start-chrome-devtools.bat</code></div>
                            <div>2. <span class="text-green-400">你手动登录 ChatGPT</span>（确保登录成功）</div>
                            <div>3. 点击"开始验证" → 脚本自动完成 SheerID 验证</div>
                            <div>4. 适合调试：脚本只负责填表验证，登录由你控制</div>
                        </div>
                    </div>

                    <!-- CDP 全自动模式提示 -->
                    <div v-if="singleVerifyMode === 'cdp'" class="bg-gray-800/50 border border-gray-600/50 rounded p-3 mb-4">
                        <div class="text-gray-400 font-semibold mb-2 text-sm">🔌 CDP 全自动模式</div>
                        <div class="text-gray-400 text-xs space-y-1">
                            <div>1. 请先启动 Chrome: <code class="bg-gray-700 px-1">scripts\start-chrome-devtools.bat</code></div>
                            <div>2. 脚本自动登录/注册 + 验证</div>
                            <div>3. <span class="text-orange-400">⚠️ 固定指纹，多次使用容易被风控</span></div>
                            <div>4. 适用于全自动场景</div>
                        </div>
                    </div>

                    <!-- 临时邮箱账号模式提示（保留兼容性，实际已被 visual/headless 替代） -->
                    <div v-if="singleVerifyMode === 'temp_email'" class="bg-blue-900/30 border border-blue-600/50 rounded p-3 mb-4">
                        <div class="text-blue-400 font-semibold mb-2 text-sm">Camoufox 全自动模式</div>
                        <div class="text-gray-300 text-xs space-y-1">
                            <div>1. 从邮箱池选择临时邮箱</div>
                            <div>2. 脚本自动登录/注册 ChatGPT</div>
                            <div>3. 验证码自动从临时邮箱获取</div>
                            <div>4. SheerID 验证完全自动化</div>
                        </div>
                    </div>

                    <!-- 自有账号模式：需要账号密码 + 临时邮箱 -->
                    <div v-if="singleVerifyMode === 'own_account'">
                        <div class="bg-orange-900/30 border border-orange-600/50 rounded p-3 mb-4">
                            <div class="text-orange-400 font-semibold mb-1 text-sm">会弹出浏览器窗口，需手动输入验证码</div>
                            <div class="text-orange-300 text-xs space-y-1">
                                <div>1. 点击开始后会弹出真实的浏览器窗口</div>
                                <div>2. ChatGPT 验证码发到你的邮箱（如 Gmail），在窗口中输入</div>
                                <div>3. SheerID 链接发到临时邮箱，自动点击</div>
                                <div>4. 成功后 Plus 给你的自有账号</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-400 text-sm mb-1">自有账号邮箱</label>
                                <input v-model="singleChatgptEmail" type="email" placeholder="your@gmail.com"
                                    class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                            </div>
                            <div>
                                <label class="block text-gray-400 text-sm mb-1">账号密码</label>
                                <input v-model="singleChatgptPassword" type="password" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                            </div>
                        </div>
                    </div>

                    <!-- 代理模式选择 -->
                    <div class="mb-4" v-if="singleVerifyMode !== 'cdp'">
                        <label class="block text-gray-400 text-sm mb-2">代理设置</label>
                        <div class="flex flex-wrap gap-3 mb-2">
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleProxyMode === 'none' ? 'ring-2 ring-green-500' : ''">
                                <input type="radio" v-model="singleProxyMode" value="none" class="mr-2">
                                <div>
                                    <div class="font-semibold text-green-400">🌐 直连（推荐测试）</div>
                                    <div class="text-xs text-gray-400">不使用代理</div>
                                </div>
                            </label>
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleProxyMode === 'fixed' ? 'ring-2 ring-blue-500' : ''">
                                <input type="radio" v-model="singleProxyMode" value="fixed" class="mr-2">
                                <div>
                                    <div class="font-semibold text-blue-400">📍 固定代理</div>
                                    <div class="text-xs text-gray-400">指定代理地址</div>
                                </div>
                            </label>
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer bg-gray-700 px-4 py-2 rounded"
                                :class="singleProxyMode === 'pool' ? 'ring-2 ring-purple-500' : ''">
                                <input type="radio" v-model="singleProxyMode" value="pool" class="mr-2">
                                <div>
                                    <div class="font-semibold text-purple-400">🔄 代理池轮换</div>
                                    <div class="text-xs text-gray-400">从池中选择（{{ proxyStats.pool?.available || 0 }} 可用）</div>
                                </div>
                            </label>
                        </div>
                        <!-- 固定代理输入框 -->
                        <div v-if="singleProxyMode === 'fixed'" class="mt-2">
                            <input v-model="singleFixedProxy" type="text"
                                placeholder="http://user:pass@ip:port 或 socks5://ip:port"
                                class="w-full bg-gray-700 text-white px-3 py-2 rounded text-sm font-mono">
                        </div>
                    </div>
                    <div v-else class="bg-gray-700 rounded p-3 mb-4 text-gray-400 text-sm">
                        <span class="text-yellow-400">⚠️ CDP 模式</span>：代理由已打开的浏览器管理
                    </div>

                    <!-- 临时邮箱选择（两种模式都需要，但用途不同） -->
                    <div class="mb-4">
                        <label class="block text-gray-400 text-sm mb-2">
                            {{ singleVerifyMode === 'temp_email' ? '临时邮箱（登录 + 接收链接）' : '临时邮箱（只用于接收 SheerID 链接）' }}
                        </label>
                        <div class="flex gap-4 mb-2">
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer">
                                <input type="radio" v-model="singleEmailSource" value="pool" class="mr-2"> 从邮箱池选择
                            </label>
                            <label class="flex items-center text-gray-300 text-sm cursor-pointer">
                                <input type="radio" v-model="singleEmailSource" value="manual" class="mr-2"> 手动输入
                            </label>
                        </div>
                        <div v-if="singleEmailSource === 'pool'">
                            <select v-model="singleTempEmail" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                <option value="">选择邮箱...</option>
                                <option v-for="e in availableEmails" :key="e.address" :value="e.address">
                                    {{ e.address }}
                                </option>
                            </select>
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input v-model="singleManualEmail" type="email" placeholder="邮箱地址 (xxx@009025.xyz)"
                                class="bg-gray-700 text-white px-3 py-2 rounded">
                            <input v-model="singleManualJwt" type="text" placeholder="JWT Token (用于查询邮件)"
                                class="bg-gray-700 text-white px-3 py-2 rounded">
                        </div>
                        <!-- 已消耗检测提示 -->
                        <div v-if="singleEmailConsumedWarning" class="bg-red-900/50 border border-red-600 rounded p-2 mt-2">
                            <div class="text-red-400 text-xs">
                                ⚠️ 此邮箱已验证过，会导致报错 "already been approved"，请换其他邮箱！
                            </div>
                        </div>
                    </div>

                    <!-- 开始按钮 -->
                    <div>
                        <button @click="startSingleVerify" :disabled="singleRunning || singleEmailConsumedWarning"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white px-6 py-2 rounded">
                            {{ singleRunning ? '运行中...' : '开始验证' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作日志面板 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-white mb-4">操作日志</h2>
            <div class="bg-gray-700 rounded p-3 h-48 overflow-y-auto font-mono text-xs">
                <div v-for="log in logs" :key="log.time"
                    :class="log.type === 'error' ? 'text-red-400' : log.type === 'success' ? 'text-green-400' : 'text-gray-300'">
                    [{{ log.time }}] {{ log.message }}
                </div>
                <div v-if="logs.length === 0" class="text-gray-500">暂无日志</div>
            </div>
        </div>

        <!-- 账号列表 -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-white">账号列表</h2>
                <div class="flex gap-2">
                    <select v-model="statusFilter" @change="fetchAccounts"
                        class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <option value="">全部</option>
                        <option value="verified">已验证</option>
                        <option value="pending">待处理</option>
                    </select>
                    <button @click="exportAccounts" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-sm">导出</button>
                    <button @click="fetchAccounts" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-1 rounded text-sm">刷新</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-gray-400 text-sm border-b border-gray-700">
                            <th class="pb-3">邮箱</th>
                            <th class="pb-3">密码</th>
                            <th class="pb-3">状态</th>
                            <th class="pb-3">代理</th>
                            <th class="pb-3">Profile</th>
                            <th class="pb-3">备注</th>
                            <th class="pb-3">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="acc in accounts" :key="acc.email" class="border-b border-gray-700 text-gray-300">
                            <td class="py-3 text-sm font-mono">{{ acc.email }}</td>
                            <td class="py-3 text-sm font-mono text-green-400">{{ acc.password || '-' }}</td>
                            <td class="py-3">
                                <span :class="getStatusClass(acc.status)" class="px-2 py-1 rounded text-xs">{{ acc.status }}</span>
                            </td>
                            <td class="py-3 text-xs text-gray-400 max-w-xs truncate" :title="acc.proxy || '-'">
                                <span v-if="acc.proxy" class="text-purple-400">{{ acc.proxy.split('://')[1]?.split('@')[1] || acc.proxy.split('://')[1]?.split(':')[0] || acc.proxy.substring(0, 20) }}...</span>
                                <span v-else>-</span>
                            </td>
                            <td class="py-3 text-xs">
                                <span v-if="acc.profile_path" class="text-blue-400" :title="acc.profile_path">✓</span>
                                <span v-else class="text-gray-600">-</span>
                            </td>
                            <td class="py-3 text-xs text-gray-400 max-w-xs truncate">{{ acc.note || '-' }}</td>
                            <td class="py-3 flex gap-2 items-center">
                                <select :value="acc.tag || 'unused'" @change="updateAccountTag(acc.email, $event.target.value)"
                                    class="bg-gray-700 text-white text-xs px-2 py-1 rounded border-0">
                                    <option value="unused">未使用</option>
                                    <option value="sold">已售出</option>
                                    <option value="used">已使用</option>
                                </select>
                                <button @click="showAccountDetail(acc.email)"
                                    class="text-green-400 hover:text-green-300 text-sm">详情</button>
                                <button @click="selectedEmail = acc.email; prepareVerify()"
                                    class="text-blue-400 hover:text-blue-300 text-sm">验证</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="accounts.length === 0" class="text-center py-8 text-gray-500">暂无账号</div>
            </div>
        </div>

        <!-- 账号详情模态框 -->
        <div v-if="detailModal.show" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @click.self="detailModal.show = false">
            <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-white">账号详情</h3>
                    <button @click="detailModal.show = false" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div v-if="detailModal.loading" class="text-center py-8 text-gray-400">加载中...</div>
                <div v-else-if="detailModal.account">
                    <!-- 成功验证信息（如果是 verified 状态） -->
                    <div v-if="detailModal.account.status === 'verified' && detailModal.successVerification"
                        class="bg-green-900/30 border border-green-600 rounded p-4 mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-green-400 text-lg">✅</span>
                            <h4 class="text-green-400 font-semibold">验证成功 - 军人信息</h4>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="text-gray-400">姓名:</div>
                            <div class="text-white font-semibold">{{ detailModal.successVerification.first_name }} {{ detailModal.successVerification.last_name }}</div>
                            <div class="text-gray-400">军种:</div>
                            <div class="text-white">{{ detailModal.successVerification.branch }}</div>
                            <div class="text-gray-400">军人生日:</div>
                            <div class="text-white">{{ detailModal.successVerification.birth_month }} {{ detailModal.successVerification.birth_day }}, {{ detailModal.successVerification.birth_year }}</div>
                            <div class="text-gray-400">退伍日期:</div>
                            <div class="text-white">{{ detailModal.successVerification.discharge_month }} {{ detailModal.successVerification.discharge_day }}, {{ detailModal.successVerification.discharge_year }}</div>
                            <div class="text-gray-400">验证时间:</div>
                            <div class="text-white">{{ formatTime(detailModal.successVerification.completed_at || detailModal.successVerification.created_at) }}</div>
                        </div>
                    </div>

                    <!-- 基本信息 -->
                    <div class="bg-gray-700 rounded p-4 mb-4">
                        <h4 class="text-white font-semibold mb-3">ChatGPT 账号信息</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="text-gray-400">邮箱:</div>
                            <div class="text-white font-mono">{{ detailModal.account.email }}</div>
                            <div class="text-gray-400">密码:</div>
                            <div class="text-green-400 font-mono">{{ detailModal.account.password }}</div>
                            <div class="text-gray-400">状态:</div>
                            <div><span :class="getStatusClass(detailModal.account.status)" class="px-2 py-1 rounded text-xs">{{ detailModal.account.status }}</span></div>
                            <div v-if="detailModal.account.proxy" class="text-gray-400">代理:</div>
                            <div v-if="detailModal.account.proxy" class="text-purple-400 font-mono text-xs break-all">{{ detailModal.account.proxy }}</div>
                            <div v-if="detailModal.account.profile_path" class="text-gray-400">Profile 路径:</div>
                            <div v-if="detailModal.account.profile_path" class="text-blue-400 font-mono text-xs break-all">{{ detailModal.account.profile_path }}</div>
                            <div v-if="detailModal.account.profile_name" class="text-gray-400">注册姓名:</div>
                            <div v-if="detailModal.account.profile_name" class="text-white">{{ detailModal.account.profile_name }}</div>
                            <div v-if="detailModal.account.profile_birthday" class="text-gray-400">注册生日:</div>
                            <div v-if="detailModal.account.profile_birthday" class="text-white">{{ detailModal.account.profile_birthday }}</div>
                            <div class="text-gray-400">创建时间:</div>
                            <div class="text-gray-300">{{ formatTime(detailModal.account.created_at) }}</div>
                        </div>
                    </div>

                    <!-- 临时邮箱凭证（始终显示） -->
                    <div class="bg-gray-700 rounded p-4 mb-4">
                        <h4 class="text-white font-semibold mb-3">临时邮箱凭证</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <div class="text-gray-400 w-24 flex-shrink-0">登录地址:</div>
                                <div class="text-blue-400">
                                    <a href="https://one.009025.xyz/" target="_blank" class="underline hover:text-blue-300">https://one.009025.xyz/</a>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <div class="text-gray-400 w-24 flex-shrink-0">邮箱地址:</div>
                                <div class="text-white font-mono">{{ detailModal.account.email }}</div>
                            </div>
                            <div class="flex items-start gap-2">
                                <div class="text-gray-400 w-24 flex-shrink-0">JWT Token:</div>
                                <div class="flex-1 break-all">
                                    <code v-if="detailModal.account.jwt" class="text-green-400 font-mono text-xs bg-gray-800 px-2 py-1 rounded block max-h-20 overflow-y-auto">{{ detailModal.account.jwt }}</code>
                                    <span v-else class="text-gray-500 text-xs">未保存（早期账号）</span>
                                </div>
                            </div>
                            <div class="text-gray-400 text-xs mt-2 pt-2 border-t border-gray-600">
                                <span class="text-yellow-400">前端登录:</span> 输入邮箱地址即可 |
                                <span class="text-yellow-400">API 查询:</span> 使用 JWT Token
                            </div>
                        </div>
                    </div>

                    <!-- 验证统计 -->
                    <div class="bg-gray-700 rounded p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">验证尝试次数:</span>
                            <span class="text-white font-semibold">{{ detailModal.verifications.length }} 次</span>
                        </div>
                    </div>

                    <!-- 复制信息按钮 -->
                    <div class="mt-4 flex gap-2">
                        <button @click="copyAccountInfo()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                            复制登录信息
                        </button>
                        <button @click="detailModal.show = false" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded text-sm">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // 统计
            const vetStats = ref({});
            const emailPoolStats = ref({});
            const accountStats = ref({});
            const verStats = ref({});

            // 模式（4个）
            const modes = [
                { id: 'email_pool', name: '邮箱池' },
                { id: 'proxy_manage', name: '代理管理' },
                { id: 'full_auto', name: '全自动批量' },
                { id: 'single_verify', name: '单账号验证' }
            ];
            const currentMode = ref('email_pool');

            // 代理管理
            const proxyStats = ref({});
            const proxyText = ref('');
            const proxyProtocol = ref('http');
            const proxyFile = ref(null);
            const proxyParsedList = ref([]);
            const proxyParsing = ref(false);

            // 邮箱池
            const emailPool = ref([]);
            const emailCreateCount = ref(5);
            const creatingEmails = ref(false);
            const externalEmail = ref('');
            const externalJwt = ref('');

            // 全自动（批量模式）
            const autoEmailSource = ref('pool');
            const selectedPoolEmail = ref('');
            const fullAutoRunning = ref(false);
            const batchSuccessCount = ref(1);  // 成功N个后暂停

            // 单账号验证（合并原来的半自动模式）
            const singleVerifyMode = ref('visual');  // visual（可视化推荐）、headless（后台）、own_account（自有账号）、cdp（高级）
            const singleChatgptEmail = ref('');   // ChatGPT 账号（脚本登录时需要）
            const singleChatgptPassword = ref('');
            const singleEmailSource = ref('pool');  // pool 或 manual
            const singleTempEmail = ref('');        // 从邮箱池选择
            const singleManualEmail = ref('');      // 手动输入邮箱
            const singleManualJwt = ref('');        // 手动输入 JWT
            const singleRunning = ref(false);
            const singleProxyMode = ref('none');    // none/fixed/pool 代理模式
            const singleFixedProxy = ref('');       // 固定代理地址

            // 运行中任务
            const runningTask = ref(null);
            let taskPollTimer = null;

            // 账号详情模态框
            const detailModal = ref({
                show: false,
                loading: false,
                account: null,
                verifications: [],
                successVerification: null  // 成功的验证记录
            });

            // 应急登录模态框
            const emergencyModal = ref({
                show: false,
                loading: false,
                continuing: false,
                email: '',
                password: '',
                jwt: '',
                profileData: null  // 注册信息（姓名、生日）
            });

            // 时间格式化
            const formatTime = (timeStr) => {
                if (!timeStr) return '-';
                try {
                    const date = new Date(timeStr);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return timeStr;
                }
            };

            // 验证
            const accounts = ref([]);
            const statusFilter = ref('');
            const selectedEmail = ref('');
            const currentFormData = ref(null);
            const currentVerificationId = ref(null);
            const currentVeteranId = ref(null);
            const loading = ref(false);
            const logs = ref([]);

            // 可用邮箱（用于下拉选择）
            const availableEmails = computed(() => emailPool.value.filter(e => e.status === 'available'));
            // 可见邮箱（邮箱池列表显示，排除 consumed 状态）
            const visibleEmails = computed(() => emailPool.value.filter(e => e.status !== 'consumed'));

            // 检测单账号验证模式临时邮箱是否已消耗
            const singleEmailConsumedWarning = computed(() => {
                let email = '';
                if (singleEmailSource.value === 'pool') {
                    email = singleTempEmail.value;
                } else {
                    email = singleManualEmail.value;
                }
                if (!email) return false;
                const found = emailPool.value.find(e => e.address === email);
                return found && (found.status === 'consumed' || found.status === 'verified');
            });

            const addLog = (message, type = 'info') => {
                const time = new Date().toLocaleTimeString();
                logs.value.unshift({ time, message, type });
                if (logs.value.length > 50) logs.value.pop();
            };

            const fetchStatus = async () => {
                try {
                    const res = await fetch('/api/status');
                    const data = await res.json();
                    if (data.success) {
                        accountStats.value = { total: Object.values(data.accounts || {}).reduce((a, b) => a + b, 0), ...data.accounts };
                        vetStats.value = data.veterans || {};
                        verStats.value = data.verifications || {};
                    }
                } catch (e) {}
            };

            const fetchEmailPool = async () => {
                try {
                    const res = await fetch('/api/email-pool');
                    const data = await res.json();
                    if (data.success) {
                        emailPool.value = data.emails || [];
                        emailPoolStats.value = data.stats || {};
                    }
                } catch (e) {}
            };

            const reloadEmailPool = async () => {
                try {
                    addLog('正在刷新邮箱池...', 'info');
                    const res = await fetch('/api/email-pool/reload', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        addLog('邮箱池已刷新', 'success');
                        fetchEmailPool();
                    } else {
                        addLog(data.error || '刷新失败', 'error');
                    }
                } catch (e) {
                    addLog('刷新请求失败', 'error');
                }
            };

            const fetchAccounts = async () => {
                try {
                    const params = new URLSearchParams({ per_page: 50 });
                    if (statusFilter.value) params.set('status', statusFilter.value);
                    const res = await fetch(`/api/accounts?${params}`);
                    const data = await res.json();
                    if (data.success) {
                        accounts.value = data.accounts || [];
                    }
                } catch (e) {}
            };

            const updateAccountTag = async (email, tag) => {
                try {
                    const res = await fetch(`/api/accounts/${encodeURIComponent(email)}/tag`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tag })
                    });
                    const data = await res.json();
                    if (data.success) {
                        addLog(`标签已更新: ${email} → ${tag}`, 'success');
                        // 更新本地数据
                        const acc = accounts.value.find(a => a.email === email);
                        if (acc) acc.tag = tag;
                    } else {
                        addLog(data.error || '更新失败', 'error');
                    }
                } catch (e) {
                    addLog('更新标签失败', 'error');
                }
            };

            const createEmails = async () => {
                creatingEmails.value = true;
                try {
                    const res = await fetch('/api/email-pool', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ count: emailCreateCount.value })
                    });
                    const data = await res.json();
                    if (data.success) {
                        addLog(`创建了 ${data.created?.length || 0} 个邮箱`, 'success');
                        fetchEmailPool();
                    } else {
                        addLog(data.error || '创建失败', 'error');
                    }
                } catch (e) {
                    addLog('请求失败', 'error');
                } finally {
                    creatingEmails.value = false;
                }
            };

            const addExternalEmail = async () => {
                if (!externalEmail.value || !externalJwt.value) {
                    addLog('请填写邮箱地址和 JWT', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/email-pool/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: externalEmail.value, jwt: externalJwt.value })
                    });
                    const data = await res.json();
                    if (data.success) {
                        addLog('邮箱添加成功', 'success');
                        externalEmail.value = '';
                        externalJwt.value = '';
                        fetchEmailPool();
                    } else {
                        addLog(data.error || '添加失败', 'error');
                    }
                } catch (e) {
                    addLog('请求失败', 'error');
                }
            };

            const deleteEmail = async (address) => {
                if (!confirm('确定删除此邮箱?')) return;
                try {
                    await fetch(`/api/email-pool/${encodeURIComponent(address)}`, { method: 'DELETE' });
                    fetchEmailPool();
                } catch (e) {}
            };

            const prepareVerify = async () => {
                if (!selectedEmail.value) {
                    addLog('请先选择账号', 'error');
                    return;
                }
                loading.value = true;
                try {
                    const res = await fetch('/api/verify/prepare', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: selectedEmail.value })
                    });
                    const data = await res.json();
                    if (data.success) {
                        currentFormData.value = data.form_data;
                        currentVerificationId.value = data.verification_id;
                        currentVeteranId.value = data.veteran_id;
                        addLog(`获取数据: ${data.form_data.first_name} ${data.form_data.last_name} (${data.form_data.branch})`, 'success');
                    } else {
                        addLog(data.error || '获取失败', 'error');
                    }
                } catch (e) {
                    addLog('请求失败', 'error');
                } finally {
                    loading.value = false;
                }
            };

            const reportResult = async (result) => {
                if (!currentVerificationId.value) return;
                try {
                    const res = await fetch('/api/verify/result', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            verification_id: currentVerificationId.value,
                            veteran_id: currentVeteranId.value,
                            result: result
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        addLog(`结果: ${result} - ${data.message}`, result === 'success' ? 'success' : 'info');
                        if (data.action === 'next') {
                            setTimeout(prepareVerify, 500);
                        } else if (data.action === 'done') {
                            currentFormData.value = null;
                            currentVerificationId.value = null;
                            fetchStatus();
                        }
                    }
                } catch (e) {
                    addLog('请求失败', 'error');
                }
            };

            const copyFormData = () => {
                if (!currentFormData.value) return;
                navigator.clipboard.writeText(JSON.stringify(currentFormData.value, null, 2));
                addLog('已复制', 'success');
            };

            const exportAccounts = async () => {
                const res = await fetch('/api/accounts/export');
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `veterans-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            // 显示账号详情
            const showAccountDetail = async (email) => {
                detailModal.value.show = true;
                detailModal.value.loading = true;
                detailModal.value.account = null;
                detailModal.value.verifications = [];
                detailModal.value.successVerification = null;

                try {
                    const res = await fetch(`/api/accounts/${encodeURIComponent(email)}`);
                    const data = await res.json();
                    if (data.success) {
                        detailModal.value.account = data.account;
                        detailModal.value.verifications = data.verifications || [];
                        // 查找成功的验证记录
                        detailModal.value.successVerification = detailModal.value.verifications.find(v => v.status === 'success') || null;
                    } else {
                        addLog(data.error || '获取详情失败', 'error');
                        detailModal.value.show = false;
                    }
                } catch (e) {
                    addLog('获取详情请求失败', 'error');
                    detailModal.value.show = false;
                } finally {
                    detailModal.value.loading = false;
                }
            };

            // 复制账号登录信息
            const copyAccountInfo = () => {
                if (!detailModal.value.account) return;
                const acc = detailModal.value.account;
                let info = `=== ChatGPT 登录信息 ===
邮箱: ${acc.email}
密码: ${acc.password}

=== 临时邮箱凭证 ===
登录地址: https://one.009025.xyz/
邮箱地址: ${acc.email}`;

                if (acc.jwt) {
                    info += `
JWT Token: ${acc.jwt}`;
                }

                info += `

使用说明:
- 前端登录: 访问登录地址，输入邮箱地址即可
- API 查询: 使用 JWT Token 查询邮件`;

                navigator.clipboard.writeText(info);
                addLog('登录信息已复制到剪贴板', 'success');
            };

            // 启动验证任务
            const startVerifyTask = async (email, mode = 'cdp', headless = false, proxyMode = 'none', fixedProxy = '') => {
                if (!email) {
                    addLog('请选择邮箱', 'error');
                    return false;
                }
                // 固定代理模式校验
                if (proxyMode === 'fixed' && !fixedProxy) {
                    addLog('请输入固定代理地址', 'error');
                    return false;
                }
                try {
                    const res = await fetch('/api/verify/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email,
                            mode,
                            headless,
                            proxy_mode: proxyMode,
                            fixed_proxy: fixedProxy
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        let proxyInfo = '';
                        if (data.proxy_mode === 'none') proxyInfo = '直连';
                        else if (data.proxy_mode === 'fixed') proxyInfo = '固定代理';
                        else if (data.proxy_mode === 'pool') proxyInfo = '代理池';
                        addLog(`验证任务已启动: ${email} (${mode}, ${proxyInfo})`, 'success');
                        // 开始轮询状态
                        pollTaskStatus(email);
                        return true;
                    } else {
                        addLog(data.error || '启动失败', 'error');
                        return false;
                    }
                } catch (e) {
                    addLog('请求失败: ' + e.message, 'error');
                    return false;
                }
            };

            // 轮询任务状态
            const pollTaskStatus = (email) => {
                // 清除旧的轮询
                if (taskPollTimer) {
                    clearInterval(taskPollTimer);
                }

                const poll = async () => {
                    try {
                        const res = await fetch(`/api/verify/status/${encodeURIComponent(email)}`);

                        // 检查 HTTP 状态码
                        if (res.status === 401) {
                            addLog('⚠️ 前端 Session 过期，但脚本可能仍在后台运行', 'warning');
                            addLog('👉 请检查 Chrome 窗口查看实际进度', 'info');
                            addLog('👉 如需继续监控，请刷新页面后重新登录', 'info');
                            clearInterval(taskPollTimer);
                            taskPollTimer = null;
                            // 不清理 runningTask，让用户知道任务可能还在
                            return;
                        }

                        // 任务不存在（404）- 清理前端状态
                        if (res.status === 404) {
                            addLog(`任务已结束或不存在: ${email}`, 'info');
                            runningTask.value = null;
                            fullAutoRunning.value = false;
                            singleRunning.value = false;
                            clearInterval(taskPollTimer);
                            taskPollTimer = null;
                            return;
                        }

                        const data = await res.json();
                        if (data.success && data.task) {
                            const task = data.task;
                            task.email = email;

                            if (task.status === 'running') {
                                runningTask.value = task;
                                // 更新日志显示
                                if (task.logs && task.logs.length > 0) {
                                    const lastLog = task.logs[task.logs.length - 1];
                                    if (!logs.value.find(l => l.message === lastLog)) {
                                        addLog(lastLog, 'info');
                                    }
                                }
                            } else if (task.status === 'success') {
                                addLog(`✅ 验证成功: ${email}`, 'success');
                                runningTask.value = null;
                                fullAutoRunning.value = false;
                                singleRunning.value = false;
                                clearInterval(taskPollTimer);
                                taskPollTimer = null;
                                fetchStatus();
                                fetchAccounts();  // 刷新账号列表
                                fetchEmailPool();  // 刷新邮箱池
                            } else {
                                // stopped, error, failed 等状态
                                addLog(`任务结束: ${task.status} - ${task.error || ''}`, task.status === 'error' ? 'error' : 'info');
                                runningTask.value = null;
                                fullAutoRunning.value = false;
                                singleRunning.value = false;
                                clearInterval(taskPollTimer);
                                taskPollTimer = null;
                            }
                        } else if (!data.success) {
                            // API 返回失败（可能任务已结束）
                            addLog(`任务状态查询失败: ${data.error || '未知错误'}`, 'warning');
                            runningTask.value = null;
                            fullAutoRunning.value = false;
                            singleRunning.value = false;
                            clearInterval(taskPollTimer);
                            taskPollTimer = null;
                        }
                    } catch (e) {
                        console.error('Poll error:', e);
                        // 网络错误时也清理状态，避免一直轮询
                        addLog('状态查询网络错误', 'error');
                    }
                };

                // 立即执行一次，然后每3秒轮询
                setTimeout(poll, 1000);
                taskPollTimer = setInterval(poll, 3000);
            };

            // 停止任务
            const stopTask = async (email) => {
                if (!confirm('确定要停止任务吗？')) return;
                addLog(`正在停止任务: ${email}...`, 'info');
                try {
                    const res = await fetch(`/api/verify/stop/${encodeURIComponent(email)}`, {
                        method: 'POST'
                    });
                    // 检查 HTTP 状态码
                    if (res.status === 401) {
                        addLog('Session 过期，请刷新页面重新登录', 'error');
                        setTimeout(() => window.location.reload(), 2000);
                        return;
                    }
                    if (res.status === 404) {
                        addLog('任务不存在或已结束，正在清理状态...', 'warning');
                        // 强制清理前端状态
                        runningTask.value = null;
                        fullAutoRunning.value = false;
                        singleRunning.value = false;
                        if (taskPollTimer) {
                            clearInterval(taskPollTimer);
                            taskPollTimer = null;
                        }
                        return;
                    }
                    const data = await res.json();
                    if (data.success) {
                        addLog(`✓ 任务已停止: ${email}`, 'success');
                        runningTask.value = null;
                        fullAutoRunning.value = false;
                        singleRunning.value = false;
                        if (taskPollTimer) {
                            clearInterval(taskPollTimer);
                            taskPollTimer = null;
                        }
                    } else {
                        addLog(data.error || '停止失败', 'error');
                    }
                } catch (e) {
                    addLog('停止请求失败: ' + e.message, 'error');
                }
            };

            // 重启任务
            const restartTask = async (email) => {
                if (!confirm('确定要重启任务吗？')) return;
                addLog(`正在重启任务: ${email}...`, 'info');
                try {
                    const res = await fetch(`/api/verify/restart/${encodeURIComponent(email)}`, { method: 'POST' });
                    // 检查 HTTP 状态码
                    if (res.status === 401) {
                        addLog('Session 过期，请刷新页面重新登录', 'error');
                        setTimeout(() => window.location.reload(), 2000);
                        return;
                    }
                    const data = await res.json();
                    if (data.success) {
                        addLog(`✓ 任务已重启: ${email}`, 'success');
                        pollTaskStatus(email);
                    } else {
                        addLog(data.error || '重启失败', 'error');
                    }
                } catch (e) {
                    addLog('重启请求失败: ' + e.message, 'error');
                }
            };

            // 退出 ChatGPT 登录
            const logoutChatgpt = async () => {
                if (!confirm('确定要退出 ChatGPT 登录吗？\n\n这将清除浏览器中的登录状态。')) return;
                try {
                    addLog('正在退出 ChatGPT 登录...', 'info');
                    const res = await fetch('/api/logout/chatgpt', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        addLog(`✓ ${data.message}`, 'success');
                    } else {
                        addLog(data.error || data.message || '退出失败', 'error');
                    }
                } catch (e) {
                    addLog('退出登录请求失败', 'error');
                }
            };

            // 复制文本到剪贴板
            const copyText = (text) => {
                navigator.clipboard.writeText(text);
                addLog('已复制到剪贴板', 'success');
            };

            // 显示应急登录模态框
            const showEmergencyLogin = async (email) => {
                emergencyModal.value.show = true;
                emergencyModal.value.loading = true;
                emergencyModal.value.email = email;
                emergencyModal.value.password = '';
                emergencyModal.value.jwt = '';
                emergencyModal.value.profileData = null;
                emergencyModal.value.continuing = false;

                try {
                    const res = await fetch(`/api/verify/emergency/${encodeURIComponent(email)}`);
                    const data = await res.json();
                    if (data.success) {
                        emergencyModal.value.email = data.email;
                        emergencyModal.value.password = data.password;
                        emergencyModal.value.jwt = data.jwt || '';
                        emergencyModal.value.profileData = data.profile_data || null;
                        if (data.profile_data) {
                            addLog(`注册信息: ${data.profile_data.first_name} ${data.profile_data.last_name}`, 'info');
                        }
                        addLog('登录信息已加载', 'info');
                    } else {
                        addLog(data.error || '获取信息失败', 'error');
                        emergencyModal.value.show = false;
                    }
                } catch (e) {
                    addLog('请求失败: ' + e.message, 'error');
                    emergencyModal.value.show = false;
                } finally {
                    emergencyModal.value.loading = false;
                }
            };

            // 手动登录后继续验证
            const manualContinueVerify = async () => {
                if (!emergencyModal.value.email) return;
                emergencyModal.value.continuing = true;

                try {
                    const res = await fetch(`/api/verify/manual-continue/${encodeURIComponent(emergencyModal.value.email)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'cdp' })
                    });
                    // 检查 HTTP 状态码
                    if (res.status === 401) {
                        addLog('Session 过期，请刷新页面重新登录', 'error');
                        setTimeout(() => window.location.reload(), 2000);
                        return;
                    }
                    const data = await res.json();
                    if (data.success) {
                        addLog('✓ 验证任务已继续（跳过登录）', 'success');
                        emergencyModal.value.show = false;
                        // 重新开始轮询
                        pollTaskStatus(emergencyModal.value.email);
                    } else {
                        addLog(data.error || '继续验证失败', 'error');
                    }
                } catch (e) {
                    addLog('请求失败: ' + e.message, 'error');
                } finally {
                    emergencyModal.value.continuing = false;
                }
            };

            // 重启 Flask 服务
            const restartService = async () => {
                if (!confirm('确定要重启 Flask 服务吗？\n\n页面将在几秒后自动刷新。')) return;
                try {
                    const res = await fetch('/api/service/restart', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        alert('服务正在重启，5秒后自动刷新页面...');
                        setTimeout(() => location.reload(), 5000);
                    }
                } catch (e) {
                    alert('重启请求失败');
                }
            };

            // 获取运行中任务
            const fetchRunningTasks = async () => {
                try {
                    const res = await fetch('/api/verify/running');
                    const data = await res.json();
                    if (data.success && data.tasks && data.tasks.length > 0) {
                        const task = data.tasks[0];
                        runningTask.value = task;
                        // 如果有运行中任务，启动轮询
                        if (!taskPollTimer) {
                            pollTaskStatus(task.email);
                        }
                    }
                } catch (e) {}
            };

            const startFullAuto = async () => {
                if (fullAutoRunning.value) return;

                let email = '';
                if (autoEmailSource.value === 'pool') {
                    email = selectedPoolEmail.value;
                    if (!email) {
                        addLog('请从邮箱池选择邮箱', 'error');
                        return;
                    }
                } else {
                    // 创建新邮箱
                    addLog('正在创建新邮箱...', 'info');
                    try {
                        const res = await fetch('/api/email-pool', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ count: 1 })
                        });
                        const data = await res.json();
                        if (data.success && data.created && data.created.length > 0) {
                            email = data.created[0].address;
                            addLog(`创建邮箱: ${email}`, 'success');
                            fetchEmailPool();
                        } else {
                            addLog('创建邮箱失败', 'error');
                            return;
                        }
                    } catch (e) {
                        addLog('创建邮箱失败', 'error');
                        return;
                    }
                }

                fullAutoRunning.value = true;
                addLog('全自动模式需要 Camoufox，启动中...', 'info');
                if (await startVerifyTask(email, 'camoufox', true)) {
                    // 任务启动成功
                } else {
                    fullAutoRunning.value = false;
                }
            };

            const startSingleVerify = async () => {
                if (singleRunning.value) return;

                // 确定临时邮箱
                let tempEmail = '';
                let jwt = '';
                if (singleEmailSource.value === 'pool') {
                    if (!singleTempEmail.value) {
                        addLog('请从邮箱池选择临时邮箱', 'error');
                        return;
                    }
                    tempEmail = singleTempEmail.value;
                    const poolEmail = emailPool.value.find(e => e.address === tempEmail);
                    jwt = poolEmail?.jwt || '';
                } else {
                    if (!singleManualEmail.value || !singleManualJwt.value) {
                        addLog('请输入临时邮箱地址和 JWT', 'error');
                        return;
                    }
                    tempEmail = singleManualEmail.value;
                    jwt = singleManualJwt.value;
                }

                singleRunning.value = true;

                // 获取代理设置
                const proxyMode = singleProxyMode.value;
                const fixedProxy = singleFixedProxy.value;

                if (singleVerifyMode.value === 'visual') {
                    // 可视化调试模式（推荐）：Camoufox 有窗口，每次新指纹
                    addLog(`🖥️ 可视化调试模式: ${tempEmail}`, 'info');
                    addLog('Camoufox 有窗口启动中，每次自动生成新指纹...', 'info');
                    if (await startVerifyTask(tempEmail, 'camoufox', false, proxyMode, fixedProxy)) {
                        // 任务启动成功，headless=false 表示有窗口
                    } else {
                        singleRunning.value = false;
                    }
                } else if (singleVerifyMode.value === 'headless') {
                    // 全自动后台模式：Camoufox 无头
                    addLog(`🤖 全自动后台模式: ${tempEmail}`, 'info');
                    addLog('Camoufox 无头模式运行中...', 'info');
                    if (await startVerifyTask(tempEmail, 'camoufox', true, proxyMode, fixedProxy)) {
                        // 任务启动成功，headless=true 表示无头
                    } else {
                        singleRunning.value = false;
                    }
                } else if (singleVerifyMode.value === 'cdp_manual') {
                    // CDP 手动登录模式：先显示账号密码，让用户手动登录
                    addLog(`🔑 CDP 手动登录模式: ${tempEmail}`, 'info');
                    addLog('正在获取账号信息，请手动登录后点击继续...', 'warning');

                    // 显示应急登录弹窗（包含账号密码）
                    showEmergencyLogin(tempEmail);
                    return;  // 等用户点击"我已登录，继续验证"后再启动任务
                } else if (singleVerifyMode.value === 'cdp') {
                    // CDP 全自动模式：连接已打开的 Chrome，脚本自动登录
                    addLog(`🔌 CDP 全自动模式: ${tempEmail}`, 'info');
                    addLog('⚠️ 注意：固定指纹，多次使用容易被风控', 'warning');
                    addLog('连接已打开的 Chrome，脚本自动登录...', 'info');
                    if (await startVerifyTask(tempEmail, 'cdp', false, 'none', '')) {
                        // 任务启动成功，CDP 模式代理由浏览器管理
                    } else {
                        singleRunning.value = false;
                    }
                } else if (singleVerifyMode.value === 'own_account') {
                    // 自有账号模式：需要输入账号密码 + 消耗临时邮箱
                    if (!singleChatgptEmail.value || !singleChatgptPassword.value) {
                        addLog('请输入自有账号邮箱和密码', 'error');
                        singleRunning.value = false;
                        return;
                    }
                    // 固定代理校验
                    if (proxyMode === 'fixed' && !fixedProxy) {
                        addLog('请输入固定代理地址', 'error');
                        singleRunning.value = false;
                        return;
                    }
                    addLog(`自有账号模式: ${singleChatgptEmail.value}`, 'info');
                    addLog(`消耗临时邮箱: ${tempEmail}`, 'info');
                    addLog('有窗口模式启动，验证码需手动输入...', 'info');

                    // 自有账号模式：有窗口（headless=false），需要手动输入验证码
                    try {
                        const res = await fetch('/api/verify/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: singleChatgptEmail.value,
                                password: singleChatgptPassword.value,
                                temp_email: tempEmail,  // 用于接收 SheerID 链接
                                temp_jwt: jwt,
                                mode: 'camoufox',
                                headless: false,  // 有窗口，方便输入验证码
                                proxy_mode: proxyMode,
                                fixed_proxy: fixedProxy
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            addLog('任务已启动，请在浏览器窗口中输入验证码', 'success');
                            pollTaskStatus(singleChatgptEmail.value);
                        } else {
                            addLog(data.error || '启动失败', 'error');
                            singleRunning.value = false;
                        }
                    } catch (e) {
                        addLog('请求失败: ' + e.message, 'error');
                        singleRunning.value = false;
                    }
                }
            };

            const getStatusClass = (s) => ({ pending: 'bg-gray-600', registering: 'bg-blue-600', verified: 'bg-green-600', failed: 'bg-red-600' }[s] || 'bg-gray-600');

            // ========== 代理管理方法 ==========
            const proxyInputMethod = ref('paste');  // paste | upload

            const loadProxyStats = async () => {
                try {
                    const res = await fetch('/api/proxy/stats');
                    const data = await res.json();
                    if (data.success) {
                        proxyStats.value = data;
                    }
                } catch (e) {
                    console.error('加载代理统计失败', e);
                }
            };

            const parseProxyText = async () => {
                if (!proxyText.value) return;
                proxyParsing.value = true;
                try {
                    const res = await fetch('/api/proxy/parse', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: proxyText.value,
                            protocol: proxyProtocol.value
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        proxyParsedList.value = data.proxies || [];
                        addLog(`解析成功: ${data.parsed} 个代理`, 'success');
                        if (data.failed > 0) {
                            addLog(`失败: ${data.failed} 个`, 'warning');
                        }
                    } else {
                        addLog(data.error || '解析失败', 'error');
                    }
                } catch (e) {
                    addLog('请求失败', 'error');
                } finally {
                    proxyParsing.value = false;
                }
            };

            const handleProxyFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    proxyFile.value = file;
                }
            };

            const uploadProxyFile = async () => {
                if (!proxyFile.value) return;
                proxyParsing.value = true;
                try {
                    const formData = new FormData();
                    formData.append('file', proxyFile.value);
                    formData.append('protocol', proxyProtocol.value);
                    formData.append('save', 'true');  // 自动保存到代理池

                    const res = await fetch('/api/proxy/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        proxyParsedList.value = data.proxies || [];
                        addLog(`解析成功: ${data.parsed} 个代理`, 'success');

                        // 显示保存结果
                        if (data.added !== undefined) {
                            if (data.added > 0) {
                                addLog(`新增: ${data.added} 个代理`, 'success');
                            }
                            if (data.duplicates > 0) {
                                addLog(`跳过重复: ${data.duplicates} 个`, 'info');
                            }
                            addLog(`保存到: ${data.file_path}`, 'info');
                        }

                        if (data.failed > 0) {
                            addLog(`解析失败: ${data.failed} 个`, 'warning');
                        }

                        // 刷新代理池统计
                        loadProxyStats();
                    } else {
                        addLog(data.error || '上传失败', 'error');
                    }
                } catch (e) {
                    addLog('请求失败', 'error');
                } finally {
                    proxyParsing.value = false;
                }
            };

            // 保存粘贴的代理到代理池
            const saveProxyList = async () => {
                if (proxyParsedList.value.length === 0) return;

                try {
                    const res = await fetch('/api/proxy/parse', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: proxyParsedList.value.join('\n'),
                            protocol: proxyProtocol.value,
                            save: true  // 保存到代理池
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        if (data.added > 0) {
                            addLog(`新增: ${data.added} 个代理`, 'success');
                        }
                        if (data.duplicates > 0) {
                            addLog(`跳过重复: ${data.duplicates} 个`, 'info');
                        }
                        addLog(`保存到: ${data.file_path}`, 'info');

                        // 刷新代理池统计
                        loadProxyStats();
                    } else {
                        addLog(data.error || '保存失败', 'error');
                    }
                } catch (e) {
                    addLog('保存请求失败', 'error');
                }
            };

            onMounted(() => {
                fetchStatus();
                fetchEmailPool();
                fetchAccounts();
                fetchRunningTasks();  // 检查是否有运行中的任务
                loadProxyStats();  // 加载代理池统计
                setInterval(fetchStatus, 10000);
                setInterval(fetchEmailPool, 30000);
                setInterval(loadProxyStats, 30000);  // 定期刷新代理统计
            });

            return {
                vetStats, emailPoolStats, accountStats, verStats,
                modes, currentMode,
                emailPool, emailCreateCount, creatingEmails, externalEmail, externalJwt,
                autoEmailSource, selectedPoolEmail, fullAutoRunning, batchSuccessCount,
                // 单账号验证（合并后的变量）
                singleVerifyMode, singleChatgptEmail, singleChatgptPassword,
                singleEmailSource, singleTempEmail, singleManualEmail, singleManualJwt, singleRunning,
                singleProxyMode, singleFixedProxy,  // 代理模式选择
                accounts, statusFilter, selectedEmail, currentFormData, currentVerificationId, currentVeteranId, loading, logs,
                availableEmails, visibleEmails, singleEmailConsumedWarning,  // 邮箱过滤和消耗检测
                runningTask, stopTask, restartTask, restartService, logoutChatgpt,  // 任务和服务控制
                detailModal, showAccountDetail, copyAccountInfo, formatTime,  // 账号详情模态框
                emergencyModal, showEmergencyLogin, manualContinueVerify, copyText,  // 应急登录模态框
                fetchAccounts, updateAccountTag, createEmails, addExternalEmail, deleteEmail, reloadEmailPool,
                prepareVerify, reportResult, copyFormData, exportAccounts,
                startFullAuto, startSingleVerify,  // 简化后的启动函数
                // 代理管理
                proxyStats, proxyInputMethod, proxyText, proxyProtocol, proxyFile, proxyParsedList, proxyParsing,
                loadProxyStats, parseProxyText, handleProxyFileChange, uploadProxyFile, saveProxyList,
                getStatusClass
            };
        }
    }).mount('#app');
    </script>
{% endraw %}
</body>
</html>
