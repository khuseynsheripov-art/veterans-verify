# Veterans Verify - 动态任务

> 核心目标：**全自动化脚本逻辑完善**（无论 Chrome/Camoufox/无头）

**最后更新**: 2025-12-30 21:30 UTC+8

---

## ⚠️ 开发规则（强制遵守）

### 1. MCP 用途
- ✅ **监控**：观察脚本运行状态
- ✅ **调试**：脚本出错时手动探索页面结构
- ❌ **禁止**：用 MCP 手动完成验证流程（必须通过脚本）

### 2. 正确开发流程
```
1. 通过 7870 前端启动自动化任务
2. 观察脚本运行日志
3. 出错 → 用 MCP 探索页面结构 → 更新 page-selectors.md → 修复脚本
4. 重复测试直到流程跑通
```

### 3. 选择器文档
- **一份 `page-selectors.md` 两个模式共用**
- 使用 Playwright `get_by_role()` 选择器（浏览器无关）
- Chrome 和 Camoufox 都能用同样的选择器

### 4. CDP 全自动流程（核心逻辑）
```
邮箱池选择邮箱 A
    ↓
【强制】退出当前登录（无论是谁）
    ↓
打开 veterans-claim → 点击登录 → 输入邮箱 A
    ↓
系统自动判断：
  - 显示"创建密码" → 新用户 → 注册
  - 显示"输入密码" → 已有用户 → 登录
    ↓
登录成功 → 点击"验证资格条件"
    ↓
填写 SheerID 表单（邮箱用 A）
    ↓
从邮箱 A 获取验证链接 → 点击
    ↓
验证成功 → 持久化保存账号信息
```

持久化逻辑

  | 模式   | 登录账号 | 接收邮箱 | 持久化                         |
  |--------|----------|----------|--------------------------------|
  | 全自动 | A        | A        | A → verified                   |
  | 半自动 | Gmail    | B        | Gmail → verified, B → consumed |
  这里消耗的就不要在邮箱池出现了 但是账号信息可以持久化显示消耗的邮箱

**关键**：
- 注册邮箱 = 接收邮箱 = 邮箱 A（一致）这个是因为接收邮箱用过就不能在用了 但是自有的话需要消耗临时邮箱 
- 每次新任务都必须先退出登录
- 注册后必须持久化（邮箱、密码、状态）

### 5. 关键注意点
- **登录/退出必须在 chatgpt.com 主页进行**
- **Status 字段动态显示**，需要检测后决定是否选择
- **新任务启动时自动检测并退出上一个账号**
- **所有模式都消耗临时邮箱**（用于接收 SheerID 验证链接）

### 6. 模式说明

| 模式 | 说明 | 用途 |
|------|------|------|
| **CDP 手动登录** | 你手动登录，脚本自动验证 | 🔥 推荐调试 |
| CDP 全自动 | 脚本自动登录+验证 | 全自动场景 |
| 可视化调试 | Camoufox 有窗口 | 调试 |
| 全自动后台 | Camoufox 无头 | 批量 |


**CDP 手动登录流程**：
```
1. 启动 Chrome: scripts\start-chrome-devtools.bat
2. 你手动登录 ChatGPT（确保登录成功）
3. 前端选择 "CDP 手动登录" 模式
4. 选择临时邮箱 → 点击"开始验证"
5. 脚本跳过登录，直接填写 SheerID 表单 → 验证
``` 

## 固化开发流程（每次会话必做）

```
通过 7870 前端启动自动化任务，MCP 监控调试

1. 启动服务: python app.py（Flask 7870 端口）
2. 确保 Chrome 已运行: scripts\start-chrome-devtools.bat（MCP 监控用）
3. 访问前端: http://localhost:7870
4. 选择模式 → 选择邮箱 → 点击"开始验证"
5. 前端调用 /api/verify/start → 启动自动化脚本
6. 脚本自动完成：登录 → 获取验证码 → 填表 → 验证
7. Claude 用 MCP 监控浏览器状态，发现问题 → 修复脚本
8. 更新文档
```

**⚠️ 注意**：
- MCP 用于**监控**浏览器状态，不是手动操作
- 验证码/链接由 `email_manager.py` API 自动获取
- 手动测试只用于探索页面结构，正式测试必须通过前端 API

---

## 当前任务（按顺序完善）

| # | 任务 | 优先级 | 状态 | 说明 |
|---|------|--------|------|------|
| 1 | **CDP 全自动模式** | 🔥最高 | 🧪 待测试 | 脚本自动登录+验证，完善检测+持久化 |
| 2 | **CDP 手动登录模式** | 高 | ⏸️ 暂缓 | 共用代码，全自动完成后自动受益 |
| 3 | **Camoufox 可视化/无头** | 中 | 待测试 | 也共用验证逻辑 |

### 优先级调整说明（2025-12-30 21:30 UTC+8）

```
原计划：CDP 手动 → CDP 全自动 → 无头
新计划：CDP 全自动 → CDP 手动 → 可视化/无头

原因：
1. CDP 全自动可以完全自动测试，不需要每次手动登录
2. CDP 手动和全自动共用验证检测+持久化代码
3. 全自动跑通后，手动模式自动受益
4. Camoufox 也共用验证逻辑，最后测试
```

### 测试账号（已注册）

| 邮箱 | 密码 | 姓名 | 生日 | 状态 |
|------|------|------|------|------|
| gnqa47tpj@009025.xyz | 0UOJ3ERxx8zIeQax | John Smith | 1999-09-25 | ✅ 数据库已更新 |
| fihc09von@009025.xyz | 5qXmRKbHpd4gvozx | Elizabeth White | 2000-02-26 | ✅ 数据库已更新 |

> 两个测试账号已手动更新数据库状态为 verified，刷新前端即可看到

### ✅ 已修复的 Bug（2025-12-30）

**Bug 5: 账号标签功能** ✅ 已添加（2025-12-30 21:15 UTC+8）
- 新增：账号列表操作列添加标签选择器（未使用/已售出/已使用）
- 修改：
  - `database.py`：accounts 表添加 tag 字段，update_account 支持 tag
  - `app.py`：添加 `/api/accounts/<email>/tag` PUT 接口
  - `index.html`：操作列添加下拉选择器
- 迁移：自动为旧数据添加 tag 字段，默认值 unused

**Bug 4: 验证成功后前端不自动刷新** ✅ 已修复（2025-12-30 20:55 UTC+8）
- 问题：验证成功后脚本没有正确返回成功状态，前端不自动刷新邮箱池和账号列表
- 根因：
  - `state == "success"` 时，持久化后 `continue` 继续循环，没有 `return True`
  - 脚本没有正确退出（退出码不是 0），后端任务状态不会变成 `success`
  - 前端只在 `task.status === 'success'` 时刷新，所以永远不刷新
- 修复：
  - `run_verify.py`：`state == "success"` 持久化后直接 `return True`
  - `run_verify.py`：`state == "success_claim"` 也持久化并 `return True`
  - `index.html`：成功时同时刷新账号列表和邮箱池

**Bug 1: about-you 页面生日填写错误** ✅ 待验证
- 问题：spinbutton 填的是 2025/1/1，应该是正确生日
- 修复：从邮箱池获取注册信息，英文月份转数字

**Bug 2: 验证成功后未持久化** ✅ 已修复
- 问题：脚本只在 Stripe 页面持久化，但 Continue 后 Session 丢失到不了 Stripe
- 修复：在检测到 "You've been verified" 或 "Claim offer" 时立即持久化
- 现在不需要等 Stripe，成功即返回

**Bug 3: Continue 后 Session 丢失** ⚠️ 不影响
- 问题：验证成功点击 Continue 后登录状态丢失
- 影响：已不影响持久化和状态更新
- 说明：用户手动登录后访问 veterans-claim 领取即可，脚本不需要处理支付

### 下个会话任务

**本次会话已完成（2025-12-30）：**
- [x] 修复验证成功后返回 True（触发前端刷新）
- [x] 前端成功后同时刷新账号列表和邮箱池
- [x] 账号标签功能（未使用/已售出/已使用）
- [x] 两个测试账号状态更新到数据库

**下个会话重点：CDP 全自动模式**
- [ ] 测试完整流程：登录 → 验证 → 成功检测 → 持久化
- [ ] 验证前端自动刷新
- [ ] 完善登录逻辑（如有问题）
- [ ] 完成后 CDP 手动模式自动受益

### 下个会话固化流程

```
=== CDP 全自动模式测试 ===
1. 启动 Flask: python app.py
2. 启动 Chrome: scripts\start-chrome-devtools.bat
3. 访问 http://localhost:7870
4. 从邮箱池创建/选择一个新邮箱
5. 选择"🔌 CDP 全自动"模式
6. 点击"开始验证"
7. 观察自动流程：
   - 登录/注册 ChatGPT
   - 填写验证码
   - about-you 页面
   - SheerID 表单
   - 验证链接点击
   - 成功检测 + 持久化
8. 确认前端自动刷新（邮箱池 + 账号列表）
9. 完善问题逻辑

=== 成功后 ===
- CDP 手动模式自动受益（共用代码）
- 继续测试 Camoufox 可视化/无头
```

**重点监控**：
- 登录/注册流程
- 验证码获取和填写
- SheerID 表单填写
- 邮件验证链接获取
- 验证成功检测（"You've been verified" 或 "Claim offer"）
- 持久化（数据库 + 邮箱池）
- 前端自动刷新

---

## 本次更新（2025-12-31 15:00 UTC+8）

### ✅ 修复 CDP 全自动登录逻辑

**问题分析**（通过 MCP 手动探索页面发现）：

1. **误判已登录**
   - 原因：用 `button "打开个人资料菜单"` 判断已登录
   - 但未登录页面也有这个按钮！
   - 修复：检查是否有 `button "登录"` 按钮来判断未登录

2. **输入位置错误**
   - 原因：chatgpt.com 登录是**弹窗（dialog）**，不是跳转页面
   - CSS 选择器 `input[type="email"]` 找不到弹窗内的 textbox
   - 修复：优先检测 dialog 弹窗，在弹窗内用 `get_by_role("textbox", name="电子邮件地址")` 定位

3. **脚本没执行登录**
   - 原因：误判已登录后直接 return True
   - 修复：正确的登录状态检测逻辑

### 代码改动

| 文件 | 改动 |
|------|------|
| `run_verify.py` | 第1031-1053行：修复登录状态检测，用聊天输入框判断真正已登录 |
| `run_verify.py` | 第1089-1131行：优先检测 dialog 弹窗，在弹窗内查找邮箱输入框 |
| `run_verify.py` | 第1165-1172行：在弹窗内点击继续按钮 |
| `docs/page-selectors.md` | 新增"页面1.5: chatgpt.com 主页登录弹窗"完整选择器文档 |

### 关键发现（记录到 page-selectors.md）

```
chatgpt.com 主页登录流程：
1. 点击 button "登录" → 出现 dialog 弹窗（不是跳转页面！）
2. 弹窗内：textbox "电子邮件地址" ← 正确输入位置
3. 弹窗内：button "继续使用 Google 登录" ← 容易误点！
4. 点击 button "继续" → 跳转到 auth.openai.com
```

---

## 上次更新（2025-12-30 20:50 UTC+8）

### ✅ 完成测试 & 修复

1. **CDP 手动登录模式完整流程测试**
   - 账号：fihc09von@009025.xyz
   - 脚本自动：注册 → 填验证码 → about-you → veterans-claim → SheerID 表单 → 获取验证链接 → 点击
   - 结果：**SheerID 验证成功**（显示 "You've been verified"）

2. **修复两个 Bug**
   - ✅ Bug 1: about-you 生日填写（英文月份 → 数字转换）
   - ✅ Bug 2: 验证成功后持久化（在 "You've been verified" 时立即更新数据库和邮箱池）

### 代码改动

| 文件 | 改动 |
|------|------|
| `run_verify.py` | `handle_about_you_page()` 新增 email 参数，从邮箱池获取注册信息 |
| `run_verify.py` | `state == "success"` 时立即持久化，不依赖 Stripe 页面 |

---

## 上次更新（2025-12-31 03:55 UTC+8）

### ✅ 已完成

1. **修复登录状态检测逻辑**
   - 问题：已登录用户看到"领取优惠"但脚本检测为未登录
   - 修复：使用更宽松的检测（有 veteran/claim/verified 等关键词即认为已登录）
   - 文件：`run_verify.py` 第1544-1568行

2. **修复前端停止/重启按钮**
   - 问题：点击后无反应
   - 修复：
     - 添加 401 Session 过期检测，自动刷新页面
     - 添加 404 任务不存在检测，清理前端状态
     - 显示操作日志（"正在停止..."）

3. **修复任务状态同步**
   - 问题：任务结束后"开始验证"按钮一直显示"运行中"
   - 修复：
     - pollTaskStatus 检测 401/404 状态码
     - API 返回失败时清理前端状态
     - 成功后刷新账号列表

---

## 上次更新（2025-12-31 03:38 UTC+8）

### ✅ 已完成

1. **修复密码数据一致性问题**
   - 问题：前端显示的密码与实际不一致，导致批量/自动化时无法登录
   - 根因：创建邮箱时没有生成密码，只有在调用应急登录 API 时才临时生成
   - 修复：
     - `email_pool.py`: 创建邮箱时自动生成 ChatGPT 登录密码
     - `email_pool.py`: 添加 `migrate_add_passwords()` 迁移方法
     - `app.py`: 启动时自动为旧数据补充密码
     - `app.py`: 自动化脚本优先从邮箱池读取密码
     - `app.py`: 账号列表 API 从邮箱池补充密码
     - `index.html`: 邮箱池列表显示密码+姓名+生日（均可复制）

2. **密码获取优先级（统一）**
   - 用户提供 > 邮箱池 > 数据库 > 生成新密码并保存

3. **邮箱池列表增强**
   - 显示：密码、姓名、生日
   - 所有字段都有"复制"按钮

---

## 上次更新（2025-12-31 09:30 UTC+8）

### ✅ 已完成

1. **修复 GBK 编码错误**
   - 原因：subprocess.Popen 没有指定 encoding='utf-8'
   - 修复：app.py 两处 Popen 调用添加 `encoding='utf-8', errors='replace'`

2. **邮箱池增加注册信息**
   - 新建邮箱时自动生成随机姓名和生日
   - 添加 `update_profile()` 方法可手动更新
   - API `/api/verify/emergency/` 返回注册信息
   - 前端弹窗显示姓名+生日（用于 ChatGPT 注册时填写）

3. **CDP 手动模式整合应急登录**
   - 选择 CDP 手动模式后先显示账号密码弹窗
   - 显示注册信息（姓名、生日）保持一致性
   - 用户手动登录后点击"继续验证"

4. **记录测试账号**
   - gnqa47tpj@009025.xyz / 0UOJ3ERxx8zIeQax
   - John Smith / September 25, 1999

5. **修复一直刷新不登录的问题**
   - 原因：auth.openai.com 页面没有被 detect_page_state 识别
   - 修复：添加 `auth_page` 状态 + `unknown_state_count` 计数器

6. **完善登录逻辑**
   - 重构状态检测为 if-else 结构
   - 多种选择器尝试 + 填写后验证

---

## 上次更新（2025-12-30 23:45 UTC+8）

### ✅ 已完成

1. **修复 CDP 模式 logout_chatgpt 卡住问题**
   - 添加超时机制（整体 30s 超时）
   - CDP 兼容：使用 JavaScript 清除 localStorage/sessionStorage/cookies
   - 多种退出方式：点击退出按钮 + JS 清除 + context.clear_cookies() + 访问登出 URL
   - 每个操作都有 `asyncio.wait_for()` 超时保护

2. **完善登录逻辑，避免页面来回切换**
   - 添加 `wait_for_page_change()` 函数：每次点击后等待页面变化确认
   - 添加重试机制：`max_retries=3`
   - 更精确的状态检测：区分 "已登录" / "未登录" / "已验证"
   - 每个步骤都有明确日志输出

3. **实现应急手动登录模式**
   - 后端 API：
     - `GET /api/verify/emergency/<email>` - 获取邮箱+密码
     - `POST /api/verify/manual-continue/<email>` - 用户手动登录后继续
   - 前端 UI：
     - 运行任务面板新增"🆘 应急登录"按钮
     - 应急登录模态框：显示邮箱/密码 + 登录步骤说明
     - "我已登录，继续验证"按钮
   - 脚本支持：
     - `--skip-login` 参数：跳过登录步骤，直接验证
     - 验证用户是否真的已登录

### 🐛 原问题回顾

1. **CDP 模式下 `logout_chatgpt` 卡住** ✅ 已修复
   - 原因：`context.clear_cookies()` 在 CDP 模式下不支持
   - 解决：使用 JavaScript 清除 + 超时保护

2. **登录/验证页面来回切换** ✅ 已修复
   - 原因：点击按钮后没有等待页面变化就继续操作
   - 解决：添加 `wait_for_page_change()` 等待确认

---

## 上次更新（2025-12-30 16:00 UTC+8）

### ✅ 已完成

1. **修正固化开发流程文档**
   - 明确：通过 7870 前端 API 启动任务，而非手动 MCP 操作
   - MCP 用于监控/调试，脚本自动获取验证码

2. ~~**验证码提取优化**~~ ✅
   - 修复 Subject Base64 解码
   - 添加排除列表 `EXCLUDE_CODES`

---

## 上次更新（2025-12-30 06:15 UTC+8）

### ✅ 已完成

1. **修复 run_verify.py 状态检测逻辑**
   - 新增 `veterans_claim_not_logged_in` 状态（检测到未登录）
   - 改进 veterans-claim 页面判断：区分已登录/未登录
   - 未登录时自动点击 "Log in" 或 "Get started" 按钮

2. **修复验证按钮失败处理**
   - 新增 `verify_btn_failures` 计数器
   - 连续 3 次找不到验证按钮 → 自动退出登录

3. **配置 chrome-devtools MCP**
   - 在 `.claude.json` 中为项目启用 `chrome-devtools` MCP
   - 重启 Claude Code 后可用 `mcp__chrome-devtools__*` 工具

4. **修复 camoufox_verify.py**
   - Status 字段值改为 `"Military Veteran or Retiree"`
   - 改用 `get_by_role()` 定位下拉框
   - Status 字段动态检测

5. **代理模式选择功能**
   - 前端新增：直连/固定代理/代理池 三种模式

---

## 测试步骤（正确流程）

```
1. 启动 Flask: python app.py
2. 启动 Chrome: scripts\start-chrome-devtools.bat（MCP 监控）
3. 浏览器访问: http://localhost:7870
4. 选择"单账号验证"模式
5. 选择"可视化调试"（Camoufox 有窗口）
6. 从邮箱池选择一个可用邮箱
7. 点击"开始验证"
8. 观察 Camoufox 浏览器自动操作
9. 检查前端日志，发现问题 → 修复脚本
```

---

## Chrome MCP 配置说明

| 配置项 | 值 |
|--------|-----|
| 调试端口 | 9488 |
| Profile 目录 | `C:\temp\codex-chrome-profile` |
| MCP 服务器 | `chrome-devtools` |
| 启动脚本 | `scripts\start-chrome-devtools.bat` |

**检查 MCP 状态**：重启后运行 `/mcp` 查看是否已连接

---

## 自动化模式现状

| 模式 | 浏览器 | 代理 | 状态 |
|------|--------|------|------|
| MCP 接管 | Chrome (CDP) | 浏览器配置 | 🔧 待测试（推荐） |
| 可视化调试 | Camoufox 有窗口 | 可选择 | 🔧 待测试 |
| 全自动批量 | Camoufox 无头 | 可选择 | 🔧 待测试 |

---

## 待定任务池

| 任务 | 优先级 | 说明 |
|------|--------|------|
| 全自动批量完善 | 中 | 邮箱池批量验证 |
| Profile 清理工具 | 低 | 前端一键删除 |
| 验证历史图表 | 低 | 可视化成功率 |

---

## 已完成（最近）

| 日期 | 任务 |
|------|------|
| 2025-12-30 | 修复状态检测 + 配置 MCP + 代理模式选择 |
| 2025-12-30 | 修复 camoufox_verify.py 选择器 |
| 2025-12-30 | Camoufox 可视化模式启动测试 |
| 2025-12-29 | 模式架构重新设计 |

---

## 使用规则

1. **新需求来了** → 自动补到第 1 个任务槽
2. **完成任务** → 移到"已完成"
3. **保持 3 个任务** → 不多不少
4. **核心目标不变** → 全自动化脚本逻辑完善
