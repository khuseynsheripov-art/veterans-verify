# Veterans Verify - 动态任务

> 核心目标：**全模式自动化脚本逻辑完善**

**最后更新**: 2026-01-03 01:00 UTC+8

---

## 当前任务

| # | 任务 | 优先级 | 状态 |
|---|------|--------|------|
| 1 | **CDP 全自动登录测试**（两个场景） | 🔥高 | 进行中 |
| 2 | **两套登录逻辑统一** | 🔥高 | 待处理 |
| 3 | **任务控制按钮修复** | 中 | 待排查 |

### CDP 全自动测试场景

| 场景 | 邮箱 | 说明 | 状态 |
|------|------|------|------|
| 全新未注册 GPT | mzlr81fos@009025.xyz | 完整注册流程 | 待测试 |
| 已注册未验证 | pbtb15ocb@009025.xyz | 登录+验证流程 | 待测试 |

---

## 七种模式确认

| 模式 | 浏览器 | 账号来源 | 需要选择账号？ |
|------|--------|---------|--------------|
| 邮箱池管理 | - | - | - |
| Camoufox 批量 | 无头 | 临时邮箱 | ❌ 固定 |
| Camoufox 可视化 | 有窗口 | 临时/自有 | ✅ 需要 |
| Camoufox 无头全自动 | 无头 | 临时邮箱 | ❌ 固定 |
| Camoufox 无头自有 | 无头 | 自有账号 | ❌ 固定 |
| CDP 全自动 | CDP Chrome | 临时邮箱 | ❌ 固定 |
| CDP 手动 | CDP Chrome | 临时/自有 | ✅ 需要 |

**需要账号来源选择**：Camoufox 可视化、CDP 手动
**固定临时邮箱**：Camoufox 批量、Camoufox 无头全自动、CDP 全自动
**固定自有账号**：Camoufox 无头自有

---

## 问题清单

> 详见 `DESIGN_REVIEW.md` 第九章

---

## 使用规则

1. **新需求来了** → 自动补到第 1 个任务槽
2. **完成任务** → 移到"已完成"
3. **保持 3 个任务** → 不多不少
4. **核心目标不变** → 全模式自动化脚本逻辑完善

---

## 2026-01-02 设计确定

### ✅ 六种操作模式确定

**详见 CLAUDE.md**：
| 模式 | 浏览器 | 账号来源 | 登录方式 | 说明 |
|------|--------|---------|---------|------|
| 邮箱池管理 | - | - | - | 独立功能 |
| Camoufox 批量 | 无头 | 临时邮箱 | 脚本自动 | 自动创建邮箱→注册→验证→下一个 |
| Camoufox 可视化 | 有窗口 | 临时/自有 | 脚本自动 | 调试用 |
| Camoufox 无头全自动 | 无头 | 临时邮箱 | 脚本自动 | 单个临时邮箱 |
| Camoufox 无头自有 | 无头 | 自有账号 | 脚本自动 | 单个自有账号 |
| CDP 手动 | CDP Chrome | 临时/自有 | 用户手动 | **保底机制** |

### ✅ 自动退出/登录逻辑

```
所有模式（除 CDP 手动外）：
  新任务开始 → 自动退出上一个账号 → 自动登录当前账号

临时邮箱：自动退出 → 自动注册/登录（脚本处理验证码）
自有账号：自动退出 → 自动登录（使用前端输入的账号密码）
CDP 手动：用户手动登录 → 脚本只做验证 → 区分账号类型用于持久化
```

### ✅ 持久化逻辑确定

新增字段（详见 CLAUDE.md）：
```python
{
    "is_own_account": False,      # 是否自有账号
    "consuming_email": None,      # 消耗邮箱（自有账号时必填）
    "consuming_email_jwt": None,  # 消耗邮箱的 JWT
}
```

---

## 待开发功能

### 1. 前端账号来源下拉切换

**交互设计**:
```
账号来源: [下拉选择 ▼]
  ├─ 选择邮箱池 → 显示邮箱池下拉
  └─ 手动输入自有账号 → 显示邮箱+密码输入框 + 消耗邮箱选择
```

**涉及文件**: `templates/index.html`, `app.py`

---

## 待测试场景

### CDP 全自动模式

| 场景 | 描述 | 状态 |
|------|------|------|
| 新邮箱注册 | 从未注册过 GPT 的邮箱 → 完整注册流程 | 待测试 |
| 已注册未验证 | 已注册 GPT 但未验证退伍军人 → 跳过注册直接验证 | 待测试 |

**测试邮箱**:
- pbtb15ocb@009025.xyz（已注册 GPT，未验证）
- lqsx92fii@009025.xyz（从未使用）

---

## 模式对比

| 模式 | 登录方式 | about-you | 验证 | 状态 |
|------|---------|-----------|------|------|
| CDP 手动登录 | 用户手动 | 用户手动 | 脚本自动 | ✅ 可用 |
| CDP 全自动 | 脚本自动 | 脚本自动 | 脚本自动 | 🔧 修复中 |
| Camoufox | 脚本自动 | 脚本自动 | 脚本自动 | ⏸️ 待同步 |

**核心理解**：
- CDP 手动模式只负责**验证流程**，登录由用户完成 → 不涉及 about-you 页面
- CDP 全自动和 Camoufox 都需要**完整登录流程** → 涉及 about-you spinbutton

---

## 开发流程

```bash
# 1. 启动服务
python app.py                           # Flask 7870
scripts\start-chrome-devtools.bat       # Chrome MCP

# 2. 前端操作
访问 http://localhost:7870
选择模式 → 选择邮箱 → 开始验证

# 3. 问题排查
脚本卡住 → MCP 查看页面状态 → 更新选择器
```

---

## 文档

| 文档 | 内容 |
|------|------|
| `CLAUDE.md` | 项目规则、技术栈 |
| `PLAN.md` | 开发计划、进度 |
| `docs/page-selectors.md` | 页面选择器（MCP 验证） |

---

## 历史问题（已修复）

<details>
<summary>点击展开</summary>

### 2026-01-03 修复

1. **spinbutton 多语言支持** - 中英双语 aria-label 匹配
2. **前端密码显示不一致** - 列表接口不再覆盖数据库密码
3. **logout_chatgpt() 中英双语** - 退出登录支持英文环境
4. **登录检测中英双语** - run_verify_loop() 登录检测支持英文
5. **切换账号未退出 bug** - auto_login_chatgpt() 检测当前账号是否是目标邮箱

### 2026-01-02 修复

1. **about-you spinbutton 选择器** - div 不是 input，改用 get_by_role
2. **新任务自动退出账号** - 简化退出逻辑

### 2026-01-01 修复

1. **创建密码页面卡住** - 邮箱只读字段被误判为登录弹窗
2. **about-you 日期填写** - spinbutton 按索引填写
3. **新用户引导页面** - 添加跳过逻辑
4. **继续按钮误点** - 使用 Enter 或 exact=True
5. **auto_login_chatgpt() 函数** - 状态机模式
6. **cdp_auto 模式映射** - 添加到 CDP 判断条件
7. **弹窗检测条件** - 更宽松的检测关键词

### 2025-12-31 修复

1. **验证码页面卡住 20s** - 提前检测跳过密码查找
2. **脚本中断登录流程** - 检测 auth 页面跳过 logout
3. **登录弹窗邮箱输入** - 简化为 dialog textbox
4. **登录函数重构** - 状态机模式约 150 行

### 2025-12-30 修复

1. **验证成功后未持久化** - 检测到成功立即保存
2. **前端不自动刷新** - 成功后刷新账号列表和邮箱池
3. **账号标签功能** - 添加 unused/sold/used 标签
4. **密码数据一致性** - 创建邮箱时生成密码

</details>

---

## 使用规则

1. **新需求来了** → 自动补到第 1 个任务槽
2. **完成任务** → 移到"已完成"
3. **保持 3 个任务** → 不多不少
4. **核心目标不变** → 全自动化脚本逻辑完善
