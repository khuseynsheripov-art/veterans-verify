# Veterans Verify - 动态任务

> 核心目标：**全模式自动化脚本逻辑完善**

**最后更新**: 2026-01-02 12:10 UTC+8

---

## 当前任务

| # | 任务 | 优先级 | 状态 |
|---|------|--------|------|
| 1 | **用新邮箱重新测试 CDP 全自动**（修复后） | 🔥高 | 待处理 |
| 2 | **测试 mzlr81fos 全新注册场景** | 中 | 待处理 |
| 3 | **同步 camoufox_verify.py 的 logout 逻辑** | 低 | 待处理 |

### 2026-01-02 12:10 ✅ 修复完成：二次登录问题（设置弹窗导致）

**问题现象**：
- 新邮箱 gltn24sgu 注册成功后
- 跳转到 veterans-claim 页面时弹出**设置弹窗**（帐户页面）
- 脚本检测账号失败 → 清除 Cookies → 二次登录

**根因定位**：
1. `get_logged_in_account()` 方法3 会导航到 `#settings/Account`
2. 这会打开设置弹窗，干扰后续流程
3. 检测账号失败后，脚本会清除 Cookies 重新登录

**修复内容** (`run_verify.py`):

| 位置 | 修改 |
|------|------|
| `get_logged_in_account()` | 移除方法3（导航到设置页面） |
| `auto_login_chatgpt()` 1052-1070 | 检测账号失败时信任当前状态，不再退出重登 |

**测试流程记录**：
```
[11:59:35] 清除 36 个 cookies
[11:59:57] 验证码: 647616 ✅
[12:00:06] about-you 完成
[12:00:15] veterans-claim 页面
[12:00:17] ❌ 检测账号失败 → 导航设置页面 → 打开弹窗
[12:00:17] ❌ 清除 cookies → 二次登录
[12:00:30] 验证码: 112462 ✅（第二个）
[12:00:36] 欢迎弹窗
```

**下一步**：用新邮箱重新测试验证修复

---

### 2026-01-02 11:50 ✅ 修复完成：验证码获取旧邮件问题

**根因定位**：
1. `_decode_subject()` 正则匹配到 ARC 签名头中的 "Subject" 而非真正的邮件 Subject
2. `_is_recent_email()` 解析失败时默认返回 `True`，导致旧邮件被当作新邮件
3. `max_age_minutes=30` 太长，验证码有效期只有几分钟

**修复内容** (`email_manager.py`):

| 修改 | 原值 | 新值 |
|------|------|------|
| Subject 正则 | 无 `^` 锚点 | 添加 `^` + `MULTILINE` 确保匹配行首 |
| 邮件有效期 | 30 分钟 | 5 分钟 |
| 解析失败默认值 | `True` | `False`（安全策略） |
| 调试日志 | 无 | 显示邮件年龄

**测试验证**：
```
邮件 1: 11.0 分钟前 → 跳过 ✅
邮件 2: 13.8 分钟前 → 跳过 ✅
邮件 3: 16.9 分钟前 → 跳过 ✅
邮件 4: 67.8 分钟前 → 跳过 ✅（这就是那个旧的 952999）
```

**下一步**：用新邮箱测试完整流程（nznr19aph 已被 OpenAI 限制）

### 2026-01-02 10:30 ✅ 修复完成：密码轮换卡住问题

**根本原因定位**：
- 第一个密码错误 → 检测到 "incorrect" → 清空密码字段 → 返回 False
- 第二个密码调用时 → **页面错误消息还在** → 检测到 "incorrect" → 立即返回 False
- **第二个密码根本没机会被填写！**

**修复方案** (`run_verify.py:1102-1127`)：
```python
# 获取密码字段当前值
current_value = await password_input.evaluate("(el) => el.value")

if has_error and current_value:
    # 有错误且密码字段有值 → 刚填写的密码错误
    # 清空密码字段，返回 False 让调用方尝试下一个密码
    return False
elif has_error and not current_value:
    # 有错误但密码字段为空 → 上一轮清空后的残留状态
    # 继续填写新密码（不返回 False）
    logger.info("检测到上一轮错误残留，继续填写新密码...")
```

**预期流程**：
1. 第一个密码 → 填写 → 点击继续 → 错误 → 检测到 `has_error + 有值` → 清空 → 返回 False
2. 第二个密码 → 检测到 `has_error + 空值` → 继续填写 → 点击继续 → 成功/失败

**下一步**：测试验证修复是否生效

---

### 2026-01-02 09:50 完整流程：密码轮换 + 验证 + 同步

**背景**：
- 旧账号：数据库有密码（ChatGPT 真实密码）
- 后来批量创建邮箱池：给所有邮箱生成了新密码（可能不是真实密码）
- 导致：两个密码不一致，需要通过实际登录验证哪个是正确的
- ⚠️ 不能直接删除/覆盖，否则可能丢失正确密码 → 无法登录

**完整流程**：
1. ✅ 修复：page.evaluate 等待页面稳定
2. ✅ 修复：密码页面添加错误检测和日志
3. ✅ 修复：密码错误后清空字段以支持轮换
4. 🔄 测试：CDP 密码轮换（第一个失败 → 第二个成功）
5. ⏳ 验证：登录成功后自动同步正确密码
6. ⏳ 确认：前端显示同步后的一致密码

**问题回顾**：
- 密码轮换逻辑触发 ✅
- 第一个密码（数据库密码）被尝试 ✅
- 但脚本卡在循环输出 "✓ 输入密码完成"，无法进入下一步 ❌

**日志证据**：
```
[09:49:35] 09:49:35 [INFO] ✓ 输入密码完成
[09:49:38] 09:49:38 [INFO] ✓ 输入密码完成
[09:49:42] 09:49:42 [INFO] ✓ 输入密码完成
```

**诊断结果**：
- 代码逻辑正确（填写密码 → 查找按钮 → 点击 → continue）
- 但缺少调试日志，无法判断：
  1. 继续按钮是否被找到？
  2. 按钮是否被点击？
  3. 密码错误但未检测？

**修复方案**：

1. **添加密码错误检测**：
```python
# 优先检查错误提示
error_texts = ["incorrect", "wrong", "invalid", "错误", "不正确"]
has_error = any(err in text_lower for err in error_texts)

if has_error:
    logger.error(f"❌ 密码错误！页面提示: {text[:200]}")
    return False  # 立即返回失败，尝试下一个密码
```

2. **添加按钮查找日志**：
```python
continue_btn = await page.query_selector('button:text-is("继续"), button:text-is("Continue"), button[type="submit"]')
if continue_btn:
    logger.info("✓ 找到继续按钮，点击...")
    await continue_btn.click()
    await asyncio.sleep(3)
    logger.info("✓ 继续按钮已点击")
else:
    logger.warning("⚠️ 未找到继续按钮！等待页面变化...")
    await asyncio.sleep(2)
```

**预期效果**：
- 密码错误 → 立即返回 False → 尝试第二个密码（邮箱池密码）
- 密码正确但按钮未找到 → 日志警告
- 正常流程 → 日志清晰展示每一步

**测试结果**：
- ✅ 密码错误检测生效
- ✅ 第一个密码（数据库）失败后正确检测
- ❌ 但第二个密码未被尝试 → 页面卡在密码错误状态

**根本原因**：
- 密码错误后返回 False ✅
- 但页面还停留在密码错误状态 ❌
- 下一轮循环再次检测到相同错误 → 又立即返回 False
- 导致第二个密码永远无法填写

**最终修复方案**：
```python
if has_error:
    logger.error(f"❌ 密码错误！页面提示: {text[:200]}")
    # 清空密码字段，让下一次轮换能够重新填写
    try:
        password_input = await page.query_selector('input[type="password"]')
        if password_input:
            await password_input.fill("")
            logger.debug("✓ 已清空密码字段")
    except:
        pass
    return False
```

### 2026-01-02 08:40 修复：logout_chatgpt 简化为 Cookie 清除

**问题回顾**：
- 之前 `logout_chatgpt()` 用 120 行代码找菜单、点按钮、处理弹窗
- 太复杂脆弱，任何选择器失效就卡住
- 第一版 cookie 清除会清除**所有域名**的 cookies，包括 Flask Session

**修复方案 v2**（只清除 ChatGPT 相关 cookies）：
```python
# 获取所有 cookies
all_cookies = await context.cookies()

# 筛选：保留非 chatgpt/openai 域名的 cookies
cookies_to_keep = [c for c in all_cookies
    if 'chatgpt.com' not in c['domain']
    and 'openai.com' not in c['domain']]

# 清除后恢复
await context.clear_cookies()
await context.add_cookies(cookies_to_keep)
```

**测试结果**：
- ✅ 清除 32 个 ChatGPT cookies
- ✅ 保留 1 个 Flask Session cookie
- ✅ 日志持续输出（WebSocket 没断开）
- ✅ 退出登录成功，自动登录流程正常

### CDP 全自动测试场景

| 场景 | 邮箱 | 说明 | 状态 |
|------|------|------|------|
| 已注册未验证 | chzc96qtn@009025.xyz | 登录+验证流程 | ✅ 退出登录成功 |
| 全新未注册 GPT | mzlr81fos@009025.xyz | 完整注册流程 | 待测试 |

### ✅ 2026-01-02 修复完成

| 问题 | 修复位置 |
|------|----------|
| 欢迎弹窗误判为登录弹窗 | run_verify.py:1239-1276 |
| about-you "日"字段填不上 | run_verify.py:969-973 |
| 引导页面处理后未跳转 | run_verify.py:1333-1369 |

---

## 七种模式确认

| 模式 | 浏览器 | 账号来源 | 需要选择账号？ |
|------|--------|---------|--------------|
| 邮箱池管理 | - | - | - |
| Camoufox 批量 | 无头 | 临时邮箱 | ❌ 固定 |
| Camoufox 可视化 | 有窗口 | 临时/自有 | ✅ 需要 |
| Camoufox 无头全自动 | 无头 | 临时邮箱 | ❌ 固定 |
| Camoufox 无头自有 | 无头 | 自有账号 | ❌ 固定 |
| CDP 全自动 | CDP Chrome | 临时邮箱 | ❌ 固定 |
| CDP 手动 | CDP Chrome | 临时/自有 | ✅ 需要 |

**需要账号来源选择**：Camoufox 可视化、CDP 手动
**固定临时邮箱**：Camoufox 批量、Camoufox 无头全自动、CDP 全自动
**固定自有账号**：Camoufox 无头自有

---

## 问题清单

> 详见 `DESIGN_REVIEW.md` 第九章

---

## 使用规则

1. **新需求来了** → 自动补到第 1 个任务槽
2. **完成任务** → 移到"已完成"
3. **保持 3 个任务** → 不多不少
4. **核心目标不变** → 全模式自动化脚本逻辑完善

---

## 2026-01-02 设计确定

### ✅ 六种操作模式确定

**详见 CLAUDE.md**：
| 模式 | 浏览器 | 账号来源 | 登录方式 | 说明 |
|------|--------|---------|---------|------|
| 邮箱池管理 | - | - | - | 独立功能 |
| Camoufox 批量 | 无头 | 临时邮箱 | 脚本自动 | 自动创建邮箱→注册→验证→下一个 |
| Camoufox 可视化 | 有窗口 | 临时/自有 | 脚本自动 | 调试用 |
| Camoufox 无头全自动 | 无头 | 临时邮箱 | 脚本自动 | 单个临时邮箱 |
| Camoufox 无头自有 | 无头 | 自有账号 | 脚本自动 | 单个自有账号 |
| CDP 手动 | CDP Chrome | 临时/自有 | 用户手动 | **保底机制** |

### ✅ 自动退出/登录逻辑

```
所有模式（除 CDP 手动外）：
  新任务开始 → 自动退出上一个账号 → 自动登录当前账号

临时邮箱：自动退出 → 自动注册/登录（脚本处理验证码）
自有账号：自动退出 → 自动登录（使用前端输入的账号密码）
CDP 手动：用户手动登录 → 脚本只做验证 → 区分账号类型用于持久化
```

### ✅ 持久化逻辑确定

新增字段（详见 CLAUDE.md）：
```python
{
    "is_own_account": False,      # 是否自有账号
    "consuming_email": None,      # 消耗邮箱（自有账号时必填）
    "consuming_email_jwt": None,  # 消耗邮箱的 JWT
}
```

---

## 待开发功能

### 1. 前端账号来源下拉切换

**交互设计**:
```
账号来源: [下拉选择 ▼]
  ├─ 选择邮箱池 → 显示邮箱池下拉
  └─ 手动输入自有账号 → 显示邮箱+密码输入框 + 消耗邮箱选择
```

**涉及文件**: `templates/index.html`, `app.py`

---

## 待测试场景

### CDP 全自动模式

| 场景 | 描述 | 状态 |
|------|------|------|
| 新邮箱注册 | 从未注册过 GPT 的邮箱 → 完整注册流程 | 待测试 |
| 已注册未验证 | 已注册 GPT 但未验证退伍军人 → 跳过注册直接验证 | 待测试 |

**测试邮箱**:
- chzc96qtn@009025.xyz（已注册 GPT，未验证）
- mzlr81fos@009025.xyz（从未使用）

---

## 模式对比

| 模式 | 登录方式 | about-you | 验证 | 状态 |
|------|---------|-----------|------|------|
| CDP 手动登录 | 用户手动 | 用户手动 | 脚本自动 | ✅ 可用 |
| CDP 全自动 | 脚本自动 | 脚本自动 | 脚本自动 | 🔧 修复中 |
| Camoufox | 脚本自动 | 脚本自动 | 脚本自动 | ⏸️ 待同步 |

**核心理解**：
- CDP 手动模式只负责**验证流程**，登录由用户完成 → 不涉及 about-you 页面
- CDP 全自动和 Camoufox 都需要**完整登录流程** → 涉及 about-you spinbutton

---

## 开发流程

```bash
# 1. 启动服务
python app.py                           # Flask 7870
scripts\start-chrome-devtools.bat       # Chrome MCP

# 2. 前端操作
访问 http://localhost:7870
选择模式 → 选择邮箱 → 开始验证

# 3. 问题排查
脚本卡住 → MCP 查看页面状态 → 更新选择器
```

---

## 文档

| 文档 | 内容 |
|------|------|
| `CLAUDE.md` | 项目规则、技术栈 |
| `PLAN.md` | 开发计划、进度 |
| `docs/page-selectors.md` | 页面选择器（MCP 验证） |

---

## 历史问题（已修复）

<details>
<summary>点击展开</summary>

### 2026-01-03 修复

1. **spinbutton 多语言支持** - 中英双语 aria-label 匹配
2. **前端密码显示不一致** - 列表接口不再覆盖数据库密码
3. **logout_chatgpt() 中英双语** - 退出登录支持英文环境
4. **登录检测中英双语** - run_verify_loop() 登录检测支持英文
5. **切换账号未退出 bug** - auto_login_chatgpt() 检测当前账号是否是目标邮箱

### 2026-01-02 修复

1. **about-you spinbutton 选择器** - div 不是 input，改用 get_by_role
2. **新任务自动退出账号** - 简化退出逻辑

### 2026-01-01 修复

1. **创建密码页面卡住** - 邮箱只读字段被误判为登录弹窗
2. **about-you 日期填写** - spinbutton 按索引填写
3. **新用户引导页面** - 添加跳过逻辑
4. **继续按钮误点** - 使用 Enter 或 exact=True
5. **auto_login_chatgpt() 函数** - 状态机模式
6. **cdp_auto 模式映射** - 添加到 CDP 判断条件
7. **弹窗检测条件** - 更宽松的检测关键词

### 2025-12-31 修复

1. **验证码页面卡住 20s** - 提前检测跳过密码查找
2. **脚本中断登录流程** - 检测 auth 页面跳过 logout
3. **登录弹窗邮箱输入** - 简化为 dialog textbox
4. **登录函数重构** - 状态机模式约 150 行

### 2025-12-30 修复

1. **验证成功后未持久化** - 检测到成功立即保存
2. **前端不自动刷新** - 成功后刷新账号列表和邮箱池
3. **账号标签功能** - 添加 unused/sold/used 标签
4. **密码数据一致性** - 创建邮箱时生成密码

</details>

---

## ✅ 已完成任务（2026-01-02 09:25）

### 账号密码逻辑完善

**问题**：
- 邮箱池和数据库密码不一致（10/12 个账号）
- 登录失败时无法尝试备选密码

**解决方案**：
1. ✅ 新增 `get_password_candidates()` 函数
   - 返回所有密码候选列表
   - 检测并警告密码不一致

2. ✅ 修改 CDP 全自动登录逻辑
   - 支持多密码依次尝试
   - 记录成功的密码来源

3. ✅ 创建账号验证脚本
   - `python scripts/verify_account_passwords.py --check-only`
   - 生成报告：`data/password_check_results.json`

**验证结果**：
```
总账号数: 12
密码不一致: 10 个
仅邮箱池有密码: 2 个
密码一致: 0 个
```

**下一步**：
- 测试 CDP 全自动模式（场景 A/B）
- 验证哪个密码正确
- 统一密码数据源

---

## 使用规则

1. **新需求来了** → 自动补到第 1 个任务槽
2. **完成任务** → 移到"已完成"
3. **保持 3 个任务** → 不多不少
4. **核心目标不变** → 全自动化脚本逻辑完善
