# Veterans Verify - 项目设计审查与重构方案

> 审查日期：2026-01-02（更新）
> 审查范围：整体架构、CDP 全自动登录逻辑、模式解耦设计、代码实现问题

---

## 一、项目核心理解

### 1.1 项目目标

使用 BIRLS 数据库（19,605 条真实退伍军人数据）自动完成 ChatGPT 的 SheerID 军人验证，获得 1 年免费 Plus。

### 1.2 核心流程

```
1. 登录 ChatGPT（邮箱 → 验证码 → 密码 → about-you）
2. 导航到 veterans-claim
3. 点击 "Verify your eligibility" → 弹出 SheerID 表单
4. 填写表单 → 提交 → 等待结果
5. 如果 "Check your email" → 获取验证链接 → 点击
6. 成功 "You've been verified" → 持久化 → 点击 Continue
7. 失败 → 换数据重试（消耗军人数据）
```

### 1.3 成功标识

**只有看到这个才算成功**：
- 标题: "You've been verified"
- 按钮: "Continue" → 点击后跳转 Stripe 支付页面（$0.00）

---

## 二、架构设计审查

### 2.1 设计哲学：容错 + 可组合

**核心原则**：一个模式出问题，还能用其他模式继续！

模式之间是**可组合的模块**，不是独立的完整流程：

```
┌─────────────────────────────────────────────────────────────┐
│ 邮箱池管理（独立操作）                                        │
│   → 手动/批量创建邮箱，不依赖任何自动化                       │
└─────────────────────────────────────────────────────────────┘
                            ↓ 提供邮箱
┌─────────────────────────────────────────────────────────────┐
│ CDP 手动模式                                                  │
│   → [用户手动登录] + [验证核心] ← 已验证可用 ✅              │
└─────────────────────────────────────────────────────────────┘
                            ↑ 复用验证核心
┌─────────────────────────────────────────────────────────────┐
│ CDP 全自动模式（单个）                                        │
│   → [自动退出/登录] + [验证核心] ← 当前开发重点              │
└─────────────────────────────────────────────────────────────┘
                            ↑ 复用
┌─────────────────────────────────────────────────────────────┐
│ Camoufox 模式（单个）                                         │
│   → [启动浏览器] + [自动登录] + [验证核心] ← 独立备选        │
└─────────────────────────────────────────────────────────────┘
                            ↑ 循环调用
┌─────────────────────────────────────────────────────────────┐
│ 批量全自动模式                                                │
│   → [批量创建邮箱] + [循环: 全自动验证] + [成功后下一个]     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 为什么不能强行统一代码？

| 维度 | CDP (Chrome) | Camoufox (Firefox) |
|------|-------------|-------------------|
| 连接方式 | `connect_over_cdp()` 连接已有浏览器 | `AsyncCamoufox()` 启动新浏览器 |
| 指纹 | 用户自己的 Chrome 指纹 | 每次启动新指纹 |
| Profile | 用户已有的登录状态 | 独立 Profile 目录 |
| API | Playwright Chromium | Playwright Firefox（可能有细微差异） |
| 用途 | 日常使用、手动介入 | 批量、无人值守 |

**关键风险**：如果把所有逻辑提取到共享模块，共享模块出问题 → 所有模式都不能用！

**正确做法**：
- 各模式保持独立
- 代码重复可以接受（换取容错能力）
- 验证核心逻辑可以参考复用，但不强制依赖

### 2.3 当前状态

> ⚠️ 此章节为 2026-01-01 旧版，最新状态见 **第九章 9.1**

| 模式 | 状态 | 说明 |
|------|------|------|
| CDP 手动 | ✅ 可用 | 用户手动登录 → 脚本验证 |
| Camoufox 无头全自动 | ⏸️ 待测试 | 单个临时邮箱 |
| Camoufox 可视化 | ⏸️ 待测试 | 调试用 |
| Camoufox 批量 | ⏸️ 待开发 | 自动创建→注册→验证→下一个 |

---

## 三、代码审查

### 3.1 文件结构

```
veterans-verify/
├── run_verify.py           # CDP 模式入口（2800+ 行）⚠️ 过大
│   ├── auto_login_chatgpt()      # 新版登录状态机（300+ 行）
│   ├── register_or_login_chatgpt() # 旧版登录（450+ 行，建议弃用）
│   ├── detect_page_state()       # 页面状态检测（130 行）✅
│   ├── fill_sheerid_form()       # 表单填写（90 行）✅
│   ├── submit_form()             # 表单提交（30 行）✅
│   ├── run_verify_loop()         # 主验证循环 ✅
│   └── run_batch_verify()        # 批量验证
│
├── automation/
│   ├── camoufox_verify.py  # Camoufox 模式（930 行）
│   │   ├── CamoufoxVerifier 类
│   │   ├── register_or_login()   # 独立的登录逻辑
│   │   ├── detect_page_state()   # 重复实现（简化版）
│   │   ├── fill_sheerid_form()   # 重复实现
│   │   └── run_verify_loop()     # 主循环
│   └── config.py           # 配置
│
├── email_pool.py           # 邮箱池管理 ✅
├── email_manager.py        # 邮箱验证码/链接获取 ✅
├── database.py             # PostgreSQL 数据库 ✅
└── app.py                  # Flask Web 服务（1840+ 行）
```

### 3.2 验证核心模块（已验证可用）

| 模块 | 函数 | 文件位置 | 状态 |
|------|------|----------|------|
| 页面状态检测 | `detect_page_state()` | run_verify.py:264 | ✅ |
| 表单填写 | `fill_sheerid_form()` | run_verify.py:385 | ✅ |
| 表单提交 | `submit_form()` | run_verify.py:491 | ✅ |
| 重试按钮 | `click_try_again()` | run_verify.py:511 | ✅ |
| 验证链接 | `check_and_click_verification_link()` | run_verify.py:107 | ✅ |

**结论**：验证核心已通过 CDP 手动模式测试，不需要改动。

### 3.3 登录逻辑（问题所在）

`run_verify.py` 中存在两套登录逻辑：

1. **`auto_login_chatgpt()`** (965-1253 行) - 新版状态机
   - 尝试处理多种场景
   - 但状态检测逻辑散乱
   - 缺少对 "Log back in" 弹窗的处理

2. **`register_or_login_chatgpt()`** (1256-1702 行) - 旧版
   - 标记为"建议使用新版"
   - 逻辑更复杂，但有些边界情况处理更完整

**问题**：两套逻辑并存，维护困难，都不够完善。

---

## 四、CDP 全自动登录问题分析

### 4.1 两种登录场景

**场景 A：已注册但未验证的账号**
```
用户之前注册了 ChatGPT（可能脚本中断了）
→ 账号存在，可能有各种页面状态：
  - "欢迎回来" 弹窗
  - 新手引导页面
  - "你已准备就绪" 页面
  - 直接在 chatgpt.com 首页
→ 需要：退出当前账号 → 重新登录 → 处理引导页 → 进入验证
```

**场景 B：邮箱池新邮箱**
```
全新邮箱，从未注册过
→ 需要：退出当前账号 → 注册新账号 → 验证码 → 创建密码 → about-you → 进入验证
```

### 4.2 真实登录流程（2026-01-01 Chrome MCP 验证）

通过 Chrome DevTools MCP 实际探索的流程：

```
退出登录流程：
1. 点击"个人资料菜单"按钮
2. 点击"退出登录"菜单项
3. 确认退出弹窗 → 点击"退出登录"按钮
4. 出现 "Log back in" 弹窗：
   - [快速登录上个账号] ← 不要点
   - [登录至另一个帐户] ← CDP 全自动应该点这个
   - [创建帐户]

登录新账号流程：
1. 点击"登录至另一个帐户" 或 首页"登录"按钮
2. 弹窗输入邮箱 → 按 Enter（避免误点 Google 登录）
3. 跳转到 auth.openai.com：
   - 新邮箱：/create-account/password → 创建密码 → /email-verification → 验证码
   - 已注册：/email-verification → 验证码 或 /log-in/password → 密码
4. 可能经过 /about-you 页面
5. 登录成功，跳回 chatgpt.com
6. 可能有引导页面需要跳过
```

### 4.3 当前代码的问题

| 问题 | 说明 |
|------|------|
| 没处理 "Log back in" 弹窗 | 退出后的第一个弹窗，需要点击"登录至另一个帐户" |
| 登录弹窗误点 | 点"继续"按钮可能误点到"继续使用 Google 登录" |
| 页面顺序假设错误 | 文档说先验证码后密码，但新邮箱是先密码后验证码 |
| 状态检测混乱 | 用 URL + 文本混合判断，分支不清晰 |
| 登录成功判断不准 | 没有检查真实 DOM 元素 |

---

## 五、重构方案

### 5.1 原则

1. **不动验证核心** - CDP 手动已验证可用，保持稳定
2. **不增加耦合** - 模式之间保持独立
3. **只修复登录层** - 重写 `auto_login_chatgpt()` 这一个函数
4. **保留旧代码** - `register_or_login_chatgpt()` 暂时保留，标记废弃

### 5.2 登录状态机设计

```
状态流转图：

[任意状态]
    ↓ 检测
[已登录且在 veterans-claim?] ─是→ return True
    ↓ 否
[有 "Log back in" 弹窗?] ─是→ [点击"登录至另一个帐户"]
    ↓ 否
[在 chatgpt.com 且有登录按钮?] ─是→ [点击登录]
    ↓
[有登录弹窗?] ─是→ [输入邮箱] → [按 Enter]
    ↓
[在 auth.openai.com?]
    ├─ /create-account/password → [输入密码] → [继续]
    ├─ /email-verification → [获取验证码] → [输入] → [继续]
    ├─ /log-in/password → [输入密码] → [继续]
    ├─ /about-you → [填写年龄] → [继续]
    └─ 其他 → 等待
    ↓
[在 chatgpt.com?]
    ├─ 有引导页 → [跳过/直接导航到 veterans-claim]
    └─ 已登录 → [导航到 veterans-claim] → return True
```

### 5.3 关键改进点

| 问题 | 改进 |
|------|------|
| 没处理 "Log back in" 弹窗 | 新增检测 `button:has-text("登录至另一个帐户")` |
| 弹窗输入误点 Google | 用 `Enter` 提交，不点按钮 |
| 页面顺序假设错误 | 按 URL 路径判断，不假设顺序 |
| 状态检测混乱 | 按 URL 优先分支，清晰的 if-elif 结构 |
| 登录成功判断不准 | 检查真实 DOM 元素（聊天输入框、个人资料菜单） |

### 5.4 实施步骤

1. **用邮箱池的真实邮箱测试当前流程**
   - 获取一个 available 状态的邮箱
   - 完整走一遍 CDP 全自动流程
   - 记录每个步骤的页面状态

2. **重写 `auto_login_chatgpt()` 函数**
   - 按状态机设计重构
   - 保持函数签名不变（不影响调用方）

3. **测试场景 B（新邮箱）**
   - 从邮箱池选一个新邮箱
   - 验证完整注册+登录流程

4. **测试场景 A（已注册未验证）**
   - 用一个已创建但未验证的邮箱
   - 验证重新登录流程

5. **处理边界情况**
   - 各种引导页面
   - 网络超时
   - 验证码获取失败

---

## 六、后续规划

### 6.1 短期目标

- [ ] 完成 CDP 全自动登录逻辑
- [ ] 通过场景 A 和场景 B 测试
- [ ] 与验证核心对接，完成完整流程

### 6.2 中期目标

- [ ] Camoufox 模式调试（独立进行，不依赖 CDP）
- [ ] 批量全自动模式
- [ ] 代理池集成

### 6.3 长期方向（待定）

- 链接模式：直接访问 SheerID 验证链接
- Telegram 机器人
- 更多数据源

---

## 七、注意事项

### 7.1 不要做的事

- ❌ 把验证核心逻辑提取到共享模块（增加耦合风险）
- ❌ 强行统一 CDP 和 Camoufox 的代码（浏览器差异）
- ❌ 在登录逻辑稳定前开发其他模式
- ❌ 删除旧的 `register_or_login_chatgpt()`（可能需要回退）

### 7.2 要做的事

- ✅ 保持模式独立，一个出问题其他还能用
- ✅ CDP 手动作为保底，始终可用
- ✅ 用真实邮箱测试，不用假数据
- ✅ 每次修改后更新 PLAN.md 和 docs/page-selectors.md

---

## 八、参考资料

### 8.1 相关文档

- `CLAUDE.md` - 项目规则和技术栈
- `PLAN.md` - 开发计划和进度
- `TODO.md` - 当前任务
- `docs/page-selectors.md` - 页面选择器（需要根据本次探索更新）

### 8.2 参考项目

- `E:\test_band_gemini_mail` - 邮箱服务和批量注册逻辑
- `E:\K-12项目` - SheerID 表单验证（API 方式）

---

## 九、2026-01-02 补充审查

### 9.1 七种模式确定（更新 2.3）

| 模式 | 浏览器 | 账号来源 | 需要选择？ | 说明 | 状态 |
|------|--------|---------|----------|------|------|
| 邮箱池管理 | - | - | - | 独立功能 | ✅ 可用 |
| Camoufox 批量 | 无头 | 临时邮箱 | ❌ 固定 | 自动创建→注册→验证→下一个 | ⏸️ 待开发 |
| Camoufox 可视化 | 有窗口 | 临时/自有 | ✅ 需要 | 调试用 | ⏸️ 待测试 |
| Camoufox 无头全自动 | 无头 | 临时邮箱 | ❌ 固定 | 单个临时邮箱 | ⏸️ 待测试 |
| Camoufox 无头自有 | 无头 | 自有账号 | ❌ 固定 | 单个自有账号 | ⏸️ 待测试 |
| CDP 全自动 | CDP Chrome | 临时邮箱 | ❌ 固定 | 单个临时邮箱 | 🔧 开发中 |
| CDP 手动 | CDP Chrome | 临时/自有 | ✅ 需要 | **保底机制** | ✅ 可用 |

### 9.2 代码实现问题清单

#### 🔴 高优先级

| 问题 | 位置 | 影响 | 状态 |
|------|------|------|------|
| **spinbutton 只支持中文** | `run_verify.py:908-930`, `camoufox_verify.py:424-451` | 英文环境日期填写失败 | ✅ 已修复 |
| **两套登录逻辑并存** | `run_verify.py:957` `auto_login_chatgpt()` + `run_verify.py:1248` `register_or_login_chatgpt()` | 维护困难，逻辑冲突 | 🔧 需统一 |
| **前端密码显示不一致** | `app.py:266-280` 列表接口覆盖数据库密码 | 用户复制错误密码 | ✅ 已修复 |
| **CDP 全自动登录逻辑** | `run_verify.py:959` `auto_login_chatgpt()` | 两个场景未测试 | 🔧 开发中 |
| **任务控制按钮失效** | `app.py` 任务控制逻辑 | 无法停止/重启任务 | 待排查 |
| **脚本热重载问题** | Flask 应用 | 更新脚本需重启应用 | 待优化 |

#### 🟡 中优先级

| 问题 | 位置 | 影响 | 状态 |
|------|------|------|------|
| **is_own_account 逻辑未贯穿** | 只在 `app.py:1049` 使用 | 脚本层不知道账号类型 | 需完善 |
| **consuming_email 未传递** | 脚本层 | 自有账号验证链接获取失败 | 需完善 |
| **Camoufox 登录函数独立** | `camoufox_verify.py:278` `register_or_login()` | 与 CDP 逻辑不同步 | 需审查 |
| **run_verify.py 过大** | 2800+ 行 | 难以维护 | 可接受 |

#### 🟢 低优先级

| 问题 | 位置 | 影响 | 状态 |
|------|------|------|------|
| **代码重复** | `detect_page_state()`, `fill_sheerid_form()` 在两个文件 | 维护成本高 | 可接受（容错设计） |
| **旧函数未删除** | `register_or_login_chatgpt()` 标记废弃 | 代码冗余 | 暂时保留 |

### 9.3 自动退出/登录逻辑审查

**当前实现**：
- `run_verify.py:687` `logout_chatgpt()` - CDP 模式退出
- `camoufox_verify.py:239` `logout_chatgpt()` - Camoufox 模式退出
- `run_verify.py:957` `auto_login_chatgpt()` - CDP 自动登录
- `camoufox_verify.py:278` `register_or_login()` - Camoufox 登录

**问题**：
1. 两个 logout 函数选择器不同，可能不一致
2. 登录函数逻辑复杂，边界情况处理不完整
3. 自有账号场景未充分测试

### 9.4 持久化逻辑审查

**当前实现**：
- `app.py:1049` 判断 `is_own_account = bool(password and temp_email)`
- `app.py:1226` 计算 `sheerid_email = temp_email_param if is_own_account else email`

**问题**：
1. `is_own_account` 只在 app.py 判断，未传递到脚本层
2. `consuming_email_jwt` 未正确传递
3. 脚本层获取验证链接时可能用错邮箱的 JWT

### 9.5 待开发功能清单

| 功能 | 优先级 | 依赖 | 状态 |
|------|--------|------|------|
| spinbutton 多语言支持 | 🔥高 | 无 | ✅ 已完成 |
| 前端密码显示修复 | 🔥高 | 无 | ✅ 已完成 |
| **CDP 全自动登录测试** | 🔥高 | 无 | 🔧 进行中 |
| 前端账号来源下拉切换 | 中 | 无 | 待开发 |
| is_own_account 逻辑贯穿 | 中 | 前端下拉切换 | 待开发 |
| consuming_email 正确传递 | 中 | is_own_account 逻辑 | 待开发 |
| Camoufox 模式测试 | 中 | CDP 全自动稳定 | 待测试 |
| 任务控制按钮修复 | 中 | 无 | 待排查 |
| 批量模式开发 | 低 | Camoufox 模式稳定 | 待开发 |

### 9.6 CDP 全自动测试场景

| 场景 | 邮箱 | 说明 | 状态 |
|------|------|------|------|
| 全新未注册 GPT | mzlr81fos@009025.xyz | 需要完整注册流程 | 待测试 |
| 已注册未验证 | pbtb15ocb@009025.xyz | 需要登录+验证 | 待测试 |

**密码逻辑说明**：
- 邮箱池密码：创建邮箱时预生成，用于注册 GPT
- 数据库密码：注册成功后保存，用于后续登录
- `get_account_password()` 优先取数据库，其次邮箱池

---

### 9.7 2026-01-03 新增修复

| 修复 | 文件位置 | 说明 |
|------|----------|------|
| logout_chatgpt() 中英双语 | `run_verify.py:687-780` | 退出登录支持英文环境 |
| 登录检测中英双语 | `run_verify.py:1990-2012` | 检测是否登录支持英文 |
| **切换账号未退出 bug** | `run_verify.py:997-1012` | 验证当前账号是否是目标邮箱 |

### 9.8 CDP 全自动测试进度

| 场景 | 邮箱 | 测试结果 | 说明 |
|------|------|----------|------|
| 已注册未验证 | pbtb15ocb@009025.xyz | ✅ 登录成功 | 表单填写正常，数据已用完 |
| 全新未注册 | mzlr81fos@009025.xyz | ❌ 未正确执行 | 发现切换账号 bug，已修复 |

**下一步**：重新测试两个场景，验证修复效果

---

*文档版本：v2.3*
*最后更新：2026-01-03 02:00*
